# Kamal self-hosted fallback config. Railway is primary deployment target (see .github/workflows/deploy.yml).
service: core

image: ghcr.io/<%= ENV["GITHUB_REPOSITORY"] %>/core

servers:
  web:
    - <%= ENV["DEPLOY_SERVER_IP"] %>
  job:
    hosts:
      - <%= ENV["DEPLOY_SERVER_IP"] %>
    cmd: bundle exec sidekiq

registry:
  server: ghcr.io
  username: <%= ENV["GITHUB_ACTOR"] %>
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - REDIS_URL
    - ANTHROPIC_API_KEY
    - BACKUP_S3_BUCKET
    - BACKUP_S3_REGION
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - SLACK_ALERT_WEBHOOK_URL
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: true

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

builder:
  arch: amd64

accessories:
  db:
    image: postgres:16-alpine
    host: <%= ENV["DEPLOY_SERVER_IP"] %>
    env:
      POSTGRES_PASSWORD: <%= ENV["POSTGRES_PASSWORD"] %>
    directories:
      - data:/var/lib/postgresql/data
  redis:
    image: redis:7-alpine
    host: <%= ENV["DEPLOY_SERVER_IP"] %>
    directories:
      - data:/data
