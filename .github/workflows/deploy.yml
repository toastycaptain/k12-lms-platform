name: Deploy

on:
  workflow_run:
    workflows: ["Monorepo CI"]
    types: [completed]

jobs:
  deploy_staging:
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    name: Deploy staging
    runs-on: ubuntu-latest
    environment: staging
    defaults:
      run:
        working-directory: apps/core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby-4.0.1
      - name: Install gems
        run: bundle install --jobs 4 --retry 3
      - name: Build and push image
        run: bundle exec kamal build
      - name: Deploy to staging
        run: bundle exec kamal deploy --destination staging
      - name: Smoke test liveness
        run: curl -fsS "${{ secrets.STAGING_APP_URL }}/up"
      - name: Smoke test readiness
        run: curl -fsS "${{ secrets.STAGING_APP_URL }}/api/v1/health"
    env:
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy_production:
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    name: Deploy production
    runs-on: ubuntu-latest
    needs: deploy_staging
    environment: production
    defaults:
      run:
        working-directory: apps/core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby-4.0.1
      - name: Install gems
        run: bundle install --jobs 4 --retry 3
      - name: Deploy to production
        run: bundle exec kamal deploy --destination production
      - name: Post-deploy smoke test
        run: curl -fsS "${{ secrets.PRODUCTION_APP_URL }}/api/v1/health"
    env:
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
