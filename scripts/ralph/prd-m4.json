{
  "project": "k12-lms-platform",
  "branchName": "ralph/m4-assessment-engine",
  "description": "M4: Assessment Engine — Question Banks + Quizzes + Attempts + Accommodations + QTI Import/Export per PRD-12 and PRD-25",
  "userStories": [
    {
      "id": "US-052",
      "title": "QuestionBank model with CRUD API",
      "description": "As a teacher, I need to organize questions into banks by subject and topic so I can reuse them across quizzes.",
      "acceptanceCriteria": [
        "QuestionBank model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), created_by_id (FK → users, NOT NULL), title (string, NOT NULL), description (text), subject (string), grade_level (string), status (string, NOT NULL, default 'active'), timestamps",
        "VALID_STATUSES = %w[active archived].freeze",
        "Migration: create_question_banks table with t.references :tenant, null: false, foreign_key: true, index: true; t.references :created_by, null: false, foreign_key: { to_table: :users }; t.string :title, null: false; t.text :description; t.string :subject; t.string :grade_level; t.string :status, null: false, default: 'active'; t.timestamps",
        "Include TenantScoped concern",
        "belongs_to :created_by, class_name: 'User'",
        "has_many :questions, dependent: :destroy",
        "Validates: title presence, status presence and inclusion in VALID_STATUSES",
        "archive! method transitions active → archived (raise ActiveRecord::RecordInvalid unless status == 'active')",
        "Pundit QuestionBankPolicy: index? returns true; show? returns true; create? returns user.has_role?(:admin) || user.has_role?(:teacher); update? same as create?; destroy? same as create?; archive? same as create?; Scope resolves scope.all",
        "QuestionBankSerializer: attributes :id, :tenant_id, :created_by_id, :title, :description, :subject, :grade_level, :status, :created_at, :updated_at",
        "API routes: GET /api/v1/question_banks (index), POST /api/v1/question_banks (create), GET /api/v1/question_banks/:id (show), PATCH /api/v1/question_banks/:id (update), DELETE /api/v1/question_banks/:id (destroy), POST /api/v1/question_banks/:id/archive (member action)",
        "Controller: Api::V1::QuestionBanksController with before_action :set_question_bank for show/update/destroy/archive; create sets tenant via Current.tenant and created_by via Current.user; authorize called on every action; index uses policy_scope; optional params[:subject] and params[:grade_level] filters on index",
        "Factory :question_bank with association :tenant, association :created_by (factory: :user), sequence(:title) { |n| \"Question Bank #{n}\" }, status 'active'",
        "Request specs: list question banks, create as teacher (201), create as student (403), show, update, delete, archive, filter by subject, Rubocop passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "PRD-12: Question banks are the top-level container for organizing questions. Subject and grade_level are optional free-text filters (not enums) for flexibility. First model in M4 dependency chain."
    },
    {
      "id": "US-053",
      "title": "Question model with CRUD API and question type support",
      "description": "As a teacher, I need to create questions of various types within a question bank so I can build quizzes from a reusable pool.",
      "acceptanceCriteria": [
        "Question model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), question_bank_id (FK → question_banks, NOT NULL, indexed), created_by_id (FK → users, NOT NULL), question_type (string, NOT NULL), prompt (text, NOT NULL), choices (jsonb, default {}), correct_answer (jsonb, default {}), points (decimal, NOT NULL, default 1.0), explanation (text), position (integer, NOT NULL, default 0), status (string, NOT NULL, default 'active'), timestamps",
        "VALID_TYPES = %w[multiple_choice true_false short_answer essay matching fill_in_blank].freeze",
        "VALID_STATUSES = %w[active archived].freeze",
        "Migration: create_questions table with t.references :tenant, null: false, foreign_key: true, index: true; t.references :question_bank, null: false, foreign_key: true, index: true; t.references :created_by, null: false, foreign_key: { to_table: :users }; t.string :question_type, null: false; t.text :prompt, null: false; t.jsonb :choices, default: {}; t.jsonb :correct_answer, default: {}; t.decimal :points, null: false, default: 1.0; t.text :explanation; t.integer :position, null: false, default: 0; t.string :status, null: false, default: 'active'; t.timestamps",
        "Include TenantScoped concern",
        "belongs_to :question_bank, belongs_to :created_by (class_name: 'User')",
        "Validates: prompt presence, question_type presence and inclusion in VALID_TYPES, status presence and inclusion in VALID_STATUSES, points numericality greater_than 0",
        "JSONB choices field by type: multiple_choice stores [{text: 'Answer A', key: 'a'}, ...]; true_false stores []; short_answer stores []; essay stores []; matching stores [{left: 'Term', right: 'Definition'}, ...]; fill_in_blank stores []",
        "JSONB correct_answer field by type: multiple_choice stores {key: 'a'}; true_false stores {value: true}; short_answer stores {acceptable: ['answer1', 'answer2']}; essay stores {} (manual grading); matching stores {pairs: [{left: 'Term', right: 'Definition'}]}; fill_in_blank stores {answers: ['word1', 'word2']}",
        "auto_gradable? method returns true for multiple_choice, true_false, short_answer, matching, fill_in_blank; false for essay",
        "Pundit QuestionPolicy: same rules as QuestionBankPolicy (teachers/admin can CRUD, all authenticated can read)",
        "QuestionSerializer: attributes :id, :tenant_id, :question_bank_id, :created_by_id, :question_type, :prompt, :choices, :correct_answer, :points, :explanation, :position, :status, :created_at, :updated_at",
        "API routes: GET /api/v1/question_banks/:question_bank_id/questions (index, nested), POST /api/v1/question_banks/:question_bank_id/questions (create, nested), GET /api/v1/questions/:id (show), PATCH /api/v1/questions/:id (update), DELETE /api/v1/questions/:id (destroy)",
        "Controller: Api::V1::QuestionsController with set_question_bank for index/create, set_question for show/update/destroy; create sets tenant and created_by; index supports optional question_type filter param",
        "Factory :question with association :tenant, :question_bank, :created_by (factory: :user), question_type 'multiple_choice', prompt 'What is 2+2?', choices [{ text: '3', key: 'a' }, { text: '4', key: 'b' }, { text: '5', key: 'c' }], correct_answer { key: 'b' }, points 1.0, status 'active'; traits for :true_false, :short_answer, :essay, :matching, :fill_in_blank",
        "Request specs: list questions under a bank, create each question type as teacher, create as student (403), show, update, delete, filter by question_type, Rubocop passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "PRD-12: Questions are the atomic unit of assessment. JSONB fields store type-specific data (choices, correct answers). The auto_gradable? method will be used when scoring attempts. Factory traits for each question type simplify testing."
    },
    {
      "id": "US-054",
      "title": "Quiz model with CRUD API and lifecycle",
      "description": "As a teacher, I need to create quizzes for my courses with configurable settings so students can take timed, controlled assessments.",
      "acceptanceCriteria": [
        "Quiz model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), course_id (FK → courses, NOT NULL, indexed), created_by_id (FK → users, NOT NULL), title (string, NOT NULL), description (text), instructions (text), quiz_type (string, NOT NULL, default 'standard'), time_limit_minutes (integer, optional), attempts_allowed (integer, NOT NULL, default 1), shuffle_questions (boolean, NOT NULL, default false), shuffle_choices (boolean, NOT NULL, default false), show_results (string, NOT NULL, default 'after_submit'), points_possible (decimal), due_at (datetime), unlock_at (datetime), lock_at (datetime), status (string, NOT NULL, default 'draft'), timestamps",
        "VALID_STATUSES = %w[draft published closed archived].freeze",
        "VALID_QUIZ_TYPES = %w[standard practice survey].freeze",
        "VALID_SHOW_RESULTS = %w[after_submit after_due_date never].freeze",
        "Migration: create_quizzes with all columns listed above with appropriate types, defaults, and nullability",
        "Include TenantScoped concern",
        "belongs_to :course, belongs_to :created_by (class_name: 'User')",
        "has_many :quiz_items, dependent: :destroy",
        "has_many :questions, through: :quiz_items",
        "has_many :quiz_attempts, dependent: :destroy",
        "has_many :quiz_accommodations, dependent: :destroy",
        "Validates: title presence, status inclusion in VALID_STATUSES, quiz_type inclusion in VALID_QUIZ_TYPES, show_results inclusion in VALID_SHOW_RESULTS, attempts_allowed numericality greater_than 0, time_limit_minutes numericality greater_than 0 (allow_nil: true), points_possible numericality greater_than_or_equal_to 0 (allow_nil: true)",
        "publish! method: draft → published (raise unless draft); close! method: published → closed (raise unless published); archive! method: sets status to archived",
        "calculate_points! method: sets points_possible = quiz_items.sum(:points) and saves",
        "Add has_many :quizzes, dependent: :destroy to Course model",
        "Pundit QuizPolicy: index? true; show? true; create? admin or teacher; update? same; destroy? same; publish? same; close? same; Scope resolves scope.all",
        "QuizSerializer: attributes :id, :tenant_id, :course_id, :created_by_id, :title, :description, :instructions, :quiz_type, :time_limit_minutes, :attempts_allowed, :shuffle_questions, :shuffle_choices, :show_results, :points_possible, :due_at, :unlock_at, :lock_at, :status, :created_at, :updated_at",
        "API routes: GET /api/v1/courses/:course_id/quizzes (index), POST /api/v1/courses/:course_id/quizzes (create), GET /api/v1/quizzes/:id (show), PATCH /api/v1/quizzes/:id (update), DELETE /api/v1/quizzes/:id (destroy), POST /api/v1/quizzes/:id/publish (member), POST /api/v1/quizzes/:id/close (member)",
        "Controller: Api::V1::QuizzesController with set_course for index/create, set_quiz for show/update/destroy/publish/close; create sets tenant and created_by; index supports optional status filter",
        "Factory :quiz with association :tenant, :course, :created_by (factory: :user), sequence(:title) { |n| \"Quiz #{n}\" }, quiz_type 'standard', status 'draft', attempts_allowed 1",
        "Request specs: list, create (teacher 201, student 403), show, update, delete, publish, close, invalid status transitions (422), filter by status, Rubocop passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "PRD-12, PRD-19: Quiz is the assessment container assigned to a course. quiz_type distinguishes graded vs practice vs survey. show_results controls when students see answers. Same lifecycle pattern as Assignment (draft→published→closed→archived)."
    },
    {
      "id": "US-055",
      "title": "QuizItem join model with CRUD and reorder API",
      "description": "As a teacher, I need to add questions to a quiz with point values and ordering so the quiz has structured content.",
      "acceptanceCriteria": [
        "QuizItem model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), quiz_id (FK → quizzes, NOT NULL, indexed), question_id (FK → questions, NOT NULL, indexed), position (integer, NOT NULL, default 0), points (decimal, NOT NULL, default 1.0), timestamps",
        "Migration: create_quiz_items with all columns; add_index :quiz_items, [:quiz_id, :question_id], unique: true",
        "Include TenantScoped concern",
        "belongs_to :quiz, belongs_to :question",
        "Validates: points numericality greater_than 0; uniqueness of question_id scoped to quiz_id",
        "After save and after destroy callbacks: quiz.calculate_points! to keep quiz.points_possible in sync",
        "Pundit QuizItemPolicy: same permissions as QuizPolicy (teachers/admin CRUD)",
        "QuizItemSerializer: attributes :id, :tenant_id, :quiz_id, :question_id, :position, :points, :created_at, :updated_at",
        "API routes: GET /api/v1/quizzes/:quiz_id/quiz_items (index, ordered by position), POST /api/v1/quizzes/:quiz_id/quiz_items (create), PATCH /api/v1/quiz_items/:id (update), DELETE /api/v1/quiz_items/:id (destroy), POST /api/v1/quizzes/:quiz_id/reorder_items (member action, accepts { item_ids: [ordered ids] })",
        "Controller: Api::V1::QuizItemsController with set_quiz for index/create/reorder_items, set_quiz_item for update/destroy; reorder_items action updates position based on array order",
        "Factory :quiz_item with association :tenant, :quiz, :question, position 0, points 1.0",
        "Request specs: list items ordered by position, create item (teacher 201, student 403), update points, delete item (verify quiz.points_possible recalculates), reorder_items, duplicate question in same quiz (422), Rubocop passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "PRD-12: QuizItem joins Quiz and Question. Points can be overridden per-quiz (a question worth 1 point in a bank might be worth 5 on a specific quiz). The reorder endpoint follows the same pattern as CourseModule reorder_items."
    },
    {
      "id": "US-056",
      "title": "QuizAttempt model with start and submit API",
      "description": "As a student, I need to start and submit quiz attempts so I can take assessments within time limits.",
      "acceptanceCriteria": [
        "QuizAttempt model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), quiz_id (FK → quizzes, NOT NULL, indexed), user_id (FK → users, NOT NULL, indexed), attempt_number (integer, NOT NULL, default 1), status (string, NOT NULL, default 'in_progress'), score (decimal), percentage (decimal), started_at (datetime, NOT NULL), submitted_at (datetime), time_spent_seconds (integer), timestamps",
        "VALID_STATUSES = %w[in_progress submitted graded].freeze",
        "Migration: create_quiz_attempts with all columns; add_index :quiz_attempts, [:quiz_id, :user_id, :attempt_number], unique: true, name: 'idx_quiz_attempts_unique'",
        "Include TenantScoped concern",
        "belongs_to :quiz, belongs_to :user",
        "has_many :attempt_answers, dependent: :destroy",
        "Validates: status inclusion, attempt_number numericality greater_than 0, uniqueness of attempt_number scoped to [:quiz_id, :user_id]",
        "validate :within_attempt_limit — on create, check user's existing attempt count for this quiz < quiz.attempts_allowed",
        "validate :quiz_is_available — on create, quiz must be published, current time must be after unlock_at (if set) and before lock_at (if set)",
        "submit! method: transitions in_progress → submitted, sets submitted_at = Time.current, sets time_spent_seconds = (submitted_at - started_at).to_i; raises if not in_progress",
        "Pundit QuizAttemptPolicy: create? returns user.has_role?(:student) || user.has_role?(:teacher); show? returns user.has_role?(:admin) || user.has_role?(:teacher) || record.user_id == user.id; submit? returns record.user_id == user.id; index? returns true; Scope: students see own attempts only, teachers/admin see all",
        "QuizAttemptSerializer: attributes :id, :tenant_id, :quiz_id, :user_id, :attempt_number, :status, :score, :percentage, :started_at, :submitted_at, :time_spent_seconds, :created_at, :updated_at",
        "API routes: POST /api/v1/quizzes/:quiz_id/attempts (create/start), GET /api/v1/quizzes/:quiz_id/attempts (index), GET /api/v1/quiz_attempts/:id (show), POST /api/v1/quiz_attempts/:id/submit (member)",
        "Controller: Api::V1::QuizAttemptsController; create sets started_at = Time.current and auto-calculates attempt_number; submit action calls submit!",
        "Factory :quiz_attempt with association :tenant, :quiz, :user, attempt_number 1, status 'in_progress', started_at { Time.current }",
        "Request specs: start attempt as student (201), start when quiz not published (422), start when locked (422), start when max attempts reached (422), submit attempt, show own attempt, teacher sees all attempts, Rubocop passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "PRD-12, PRD-19: QuizAttempt tracks each student's take of a quiz. attempt_number auto-increments. The within_attempt_limit validation will be updated in US-059 to account for QuizAccommodation extra_attempts."
    },
    {
      "id": "US-057",
      "title": "AttemptAnswer model with save and auto-grade API",
      "description": "As a student, I need to save my answers during a quiz attempt, and auto-gradable questions should be scored automatically on submit.",
      "acceptanceCriteria": [
        "AttemptAnswer model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), quiz_attempt_id (FK → quiz_attempts, NOT NULL, indexed), question_id (FK → questions, NOT NULL, indexed), answer (jsonb, NOT NULL, default {}), is_correct (boolean), points_awarded (decimal), graded_at (datetime), graded_by_id (FK → users, optional), feedback (text), timestamps",
        "Migration: create_attempt_answers with all columns; add_index :attempt_answers, [:quiz_attempt_id, :question_id], unique: true, name: 'idx_attempt_answers_unique'",
        "Include TenantScoped concern",
        "belongs_to :quiz_attempt, belongs_to :question, belongs_to :graded_by (class_name: 'User', optional: true)",
        "Validates: uniqueness of question_id scoped to quiz_attempt_id",
        "JSONB answer field conventions: multiple_choice {key: 'b'}; true_false {value: true}; short_answer {text: 'answer'}; essay {text: 'long response'}; matching {pairs: [{left: 'Term', right: 'Def'}]}; fill_in_blank {answers: ['word1', 'word2']}",
        "auto_grade! instance method: if question.auto_gradable?, compare answer to question.correct_answer using type-specific logic, set is_correct/points_awarded/graded_at; for essay, leave nil (pending manual grading)",
        "Auto-grading logic: multiple_choice — answer['key'] == correct_answer['key']; true_false — answer['value'] == correct_answer['value']; short_answer — answer['text'].strip.downcase in correct_answer['acceptable'].map(&:downcase); matching — Set(answer['pairs']) == Set(correct_answer['pairs']); fill_in_blank — answer['answers'].map(&:downcase) == correct_answer['answers'].map(&:downcase)",
        "Points: full points if correct, 0 if incorrect (no partial credit required)",
        "POST /api/v1/quiz_attempts/:quiz_attempt_id/answers — bulk save/upsert answers, accepts { answers: [{ question_id, answer }] }; only allowed when attempt status is in_progress; uses find_or_initialize_by(question_id:) for upsert",
        "GET /api/v1/quiz_attempts/:quiz_attempt_id/answers — list all answers for an attempt",
        "After QuizAttempt#submit!: auto_grade! all auto-gradable answers, then calculate quiz_attempt.score = sum of points_awarded (where not nil), quiz_attempt.percentage = (score / quiz.points_possible * 100); if all questions are auto-gradable, transition attempt to 'graded'",
        "Pundit AttemptAnswerPolicy: create? if quiz_attempt.user_id == user.id and attempt in_progress; index? returns true; Scope: students see own, teachers/admin see all",
        "AttemptAnswerSerializer: attributes :id, :quiz_attempt_id, :question_id, :answer, :is_correct, :points_awarded, :graded_at, :feedback, :created_at, :updated_at",
        "Factory :attempt_answer with association :tenant, :quiz_attempt, :question, answer { { 'key' => 'b' } }",
        "Request specs: save answers during attempt, save to completed attempt (422), auto-grade on submit for MC/TF/short_answer, essay left ungraded, score and percentage calculated, all-auto transitions to graded, teacher sees all answers, Rubocop passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "PRD-12, PRD-19: AttemptAnswer + auto-grading is the core engine. Submit flow: save answers → submit attempt → auto_grade! each auto-gradable answer → calculate score → if all auto, mark graded. Essay requires manual grading (US-058)."
    },
    {
      "id": "US-058",
      "title": "Manual grading API for essay questions and quiz results endpoint",
      "description": "As a teacher, I need to manually grade essay questions and override auto-graded scores so I can provide nuanced assessment feedback.",
      "acceptanceCriteria": [
        "POST /api/v1/attempt_answers/:id/grade — teacher grades a single answer: accepts { points_awarded (decimal, required), feedback (text, optional), is_correct (boolean, optional) }; sets graded_at = Time.current, graded_by_id = Current.user.id",
        "Validate points_awarded >= 0 and <= the quiz_item.points for that question on that quiz",
        "After grading an individual answer: recalculate quiz_attempt.score and quiz_attempt.percentage",
        "If all answers in the attempt now have non-nil points_awarded: auto-transition attempt status to 'graded'",
        "POST /api/v1/quiz_attempts/:id/grade_all — bulk grade: accepts { grades: [{ attempt_answer_id, points_awarded, feedback }] }; processes all grades, recalculates attempt score once at end",
        "Teacher can override previously auto-graded answers (e.g., award partial credit for short_answer marked wrong)",
        "GET /api/v1/quizzes/:id/results — returns summary: quiz info plus list of all attempts with user_id, attempt_number, score, percentage, status; teacher/admin only",
        "Pundit: grade? on AttemptAnswerPolicy requires admin or teacher role; results? on QuizPolicy requires admin or teacher role",
        "Add routes: POST /api/v1/attempt_answers/:id/grade (member), POST /api/v1/quiz_attempts/:id/grade_all (member), GET /api/v1/quizzes/:id/results (member)",
        "Request specs: grade essay answer, recalculate score, all-answers-graded transitions attempt to graded, override auto-grade, results endpoint returns all attempts, student cannot grade (403), Rubocop passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "PRD-12, PRD-19: Manual grading completes the assessment workflow for essay questions. The grade_all endpoint enables batch grading. The results endpoint is the teacher's analytics view."
    },
    {
      "id": "US-059",
      "title": "QuizAccommodation model with CRUD API",
      "description": "As a teacher, I need to set per-student quiz accommodations so students with special needs get extra time or attempts.",
      "acceptanceCriteria": [
        "QuizAccommodation model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), quiz_id (FK → quizzes, NOT NULL, indexed), user_id (FK → users, NOT NULL, indexed), extra_time_minutes (integer, NOT NULL, default 0), extra_attempts (integer, NOT NULL, default 0), notes (text), timestamps",
        "Migration: create_quiz_accommodations with all columns; add_index :quiz_accommodations, [:quiz_id, :user_id], unique: true",
        "Include TenantScoped concern",
        "belongs_to :quiz, belongs_to :user",
        "Validates: uniqueness of user_id scoped to quiz_id, extra_time_minutes numericality greater_than_or_equal_to 0, extra_attempts numericality greater_than_or_equal_to 0",
        "Update QuizAttempt#within_attempt_limit to check: user attempt count < quiz.attempts_allowed + (accommodation&.extra_attempts || 0), where accommodation is quiz.quiz_accommodations.find_by(user_id: user_id)",
        "Add effective_time_limit method to QuizAttempt: returns quiz.time_limit_minutes + (accommodation&.extra_time_minutes || 0) if quiz.time_limit_minutes present, nil otherwise",
        "Add effective_time_limit to QuizAttemptSerializer as an attribute",
        "Pundit QuizAccommodationPolicy: CRUD restricted to admin and teacher; students cannot view accommodations",
        "QuizAccommodationSerializer: attributes :id, :tenant_id, :quiz_id, :user_id, :extra_time_minutes, :extra_attempts, :notes, :created_at, :updated_at",
        "API routes: GET /api/v1/quizzes/:quiz_id/accommodations (index), POST /api/v1/quizzes/:quiz_id/accommodations (create), PATCH /api/v1/quiz_accommodations/:id (update), DELETE /api/v1/quiz_accommodations/:id (destroy)",
        "Controller: Api::V1::QuizAccommodationsController with set_quiz for index/create, set_accommodation for update/destroy",
        "Factory :quiz_accommodation with association :tenant, :quiz, :user, extra_time_minutes 30, extra_attempts 1",
        "Request specs: create accommodation, update, delete, student with accommodation gets extra attempt allowed, effective_time_limit includes extra time, teacher CRUD (201), student access (403), duplicate user for same quiz (422), Rubocop passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "PRD-12: Accommodations are critical for accessibility and IEP/504 compliance. Extra time extends the timer; extra attempts lets the student retry beyond the quiz default."
    },
    {
      "id": "US-060",
      "title": "QTI 2.1 import/export background jobs",
      "description": "As a teacher, I need to import questions from QTI files and export question banks to QTI format so I can exchange content with other LMS platforms.",
      "acceptanceCriteria": [
        "QtiExportJob (Sidekiq): accepts question_bank_id; generates QTI 2.1 XML for all active questions; attaches result as Active Storage on QuestionBank (has_one_attached :qti_export)",
        "QTI 2.1 export: each question as <assessmentItem> with <responseDeclaration>, <outcomeDeclaration>, <itemBody>; support choiceInteraction (multiple_choice), textEntryInteraction (short_answer/fill_in_blank), inlineChoiceInteraction (true_false)",
        "QtiImportJob (Sidekiq): accepts question_bank_id and blob_id; parses QTI 2.1 XML using Nokogiri; creates Question records for recognized types; skips unrecognized with warning; sets created_by to importing user",
        "Add to QuestionBank model: has_one_attached :qti_export; add import_status (string) and import_errors (jsonb, default []) columns via migration",
        "Both jobs use QuestionBank.unscoped.find and set Current.tenant from the record's tenant_id (same pattern as PdfExportJob)",
        "API endpoints: POST /api/v1/question_banks/:id/export_qti (triggers job, returns 202), GET /api/v1/question_banks/:id/export_qti_status (returns { status, download_url }), POST /api/v1/question_banks/:id/import_qti (accepts file upload, triggers job, returns 202)",
        "Pundit: same as QuestionBankPolicy (teacher/admin only)",
        "Add nokogiri gem to Gemfile if not already present (for XML parsing/generation)",
        "Job specs: QtiExportJob generates valid XML and attaches it; QtiImportJob parses sample QTI XML and creates questions with correct types and choices",
        "Request specs: trigger export (202), check status, trigger import with file (202), student access (403), Rubocop passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "PRD-12: QTI 2.1 is the standard interchange format for assessment items. Follow the PdfExportJob pattern exactly. Keep QTI support pragmatic — MC, short answer, T/F are the most common types to support."
    },
    {
      "id": "US-061",
      "title": "Next.js Question Bank List and Editor pages",
      "description": "As a teacher, I need to browse, create, and manage question banks with their questions through a web interface.",
      "acceptanceCriteria": [
        "Update AppShell NAV_ITEMS: change Assess from { label: 'Assess', href: '/assess' } to { label: 'Assess', href: '/assess', children: [{ label: 'Question Banks', href: '/assess/banks' }, { label: 'Quizzes', href: '/assess/quizzes' }] }",
        "Question Bank List page at /assess/banks: 'use client', ProtectedRoute + AppShell wrapper, fetches GET /api/v1/question_banks, displays cards (title, subject, grade_level, status badge), 'New Bank' button for teachers/admin, filter by subject dropdown, empty state",
        "New Bank page at /assess/banks/new: form for title, description, subject, grade_level; save calls POST /api/v1/question_banks, redirects to editor",
        "Question Bank Editor page at /assess/banks/[bankId]: editable form fields (title, description, subject, grade_level) with save button",
        "Questions section within editor: lists questions from GET /api/v1/question_banks/:bankId/questions, each shows position, type badge, prompt preview (truncated), points, edit/delete buttons",
        "Add Question form: question_type dropdown, prompt textarea, dynamic fields per type (MC: choices editor with add/remove rows and correct indicator; TF: radio; short_answer: acceptable answers list with add/remove; essay: just prompt; matching: pairs editor with add/remove rows; fill_in_blank: prompt with {{blank}} markers), points input, explanation textarea, save calls POST",
        "Edit Question: loads data into form, save calls PATCH /api/v1/questions/:id",
        "Delete Question: confirm, calls DELETE, removes from list",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 10,
      "passes": false,
      "notes": "PRD-12, UX: Question Bank management is the teacher's content authoring tool. The type-specific form fields are the most complex part — each question type needs different input controls."
    },
    {
      "id": "US-062",
      "title": "Next.js Quiz Builder page",
      "description": "As a teacher, I need to build quizzes by selecting questions from banks and configuring quiz settings.",
      "acceptanceCriteria": [
        "Add Quizzes section to Course Home page (/teach/courses/[courseId]): fetch GET /api/v1/courses/:courseId/quizzes, show quiz cards (title, status badge, question count, points, due date), link to quiz builder",
        "New Quiz page at /assess/quizzes/new with courseId query param: form for title, description, course selection, save calls POST /api/v1/courses/:courseId/quizzes, redirects to builder",
        "Quiz Builder page at /assess/quizzes/[quizId]: 'use client', ProtectedRoute + AppShell wrapper",
        "Settings panel: title, description, instructions, quiz_type (select), time_limit_minutes, attempts_allowed, shuffle_questions (checkbox), shuffle_choices (checkbox), show_results (select), due_at, unlock_at, lock_at; save calls PATCH",
        "Questions panel: lists quiz items (GET /api/v1/quizzes/:quizId/quiz_items) with position, type badge, prompt preview, editable points input, remove button",
        "Add Questions: browse question banks, select questions, 'Add Selected' calls POST /api/v1/quizzes/:quizId/quiz_items for each",
        "Reorder via up/down buttons (POST /api/v1/quizzes/:quizId/reorder_items)",
        "Update points inline (PATCH /api/v1/quiz_items/:id)",
        "Remove question (DELETE /api/v1/quiz_items/:id)",
        "Points total auto-updates",
        "Publish/Close buttons with status badge",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 11,
      "passes": true,
      "notes": "PRD-12, PRD-19: Quiz Builder is the teacher's primary quiz authoring tool. Two-panel layout (settings + questions) mirrors common quiz builder UX."
    },
    {
      "id": "US-063",
      "title": "Next.js Student Quiz Attempt page",
      "description": "As a student, I need to take a quiz with a timer, answer questions, and submit my attempt.",
      "acceptanceCriteria": [
        "Quiz Start page at /assess/quizzes/[quizId]/take: shows quiz info (title, instructions, time limit, attempts allowed/used, points), 'Start Attempt' button; disabled with explanation if quiz not available or max attempts reached",
        "On start: calls POST /api/v1/quizzes/:quizId/attempts, redirects to /assess/attempts/[attemptId]",
        "Attempt page at /assess/attempts/[attemptId]: fetches attempt and quiz items",
        "Timer: countdown from effective_time_limit starting at started_at, MM:SS format, warning color at 5 min remaining, auto-submits at zero",
        "Question display: all questions on one scrollable page, each with position number, prompt, type-specific answer input (radio for MC, toggle for TF, textarea for short_answer/essay, paired selects for matching, text inputs for fill_in_blank), points possible",
        "Auto-save: on answer change, debounce then POST /api/v1/quiz_attempts/:attemptId/answers (bulk save), show saving indicator",
        "Question sidebar: numbered list showing answered vs unanswered state",
        "Submit button: confirm dialog, calls POST /api/v1/quiz_attempts/:attemptId/submit",
        "Results page at /assess/attempts/[attemptId]/results: if show_results is 'after_submit', show score, percentage, per-question results with correct/incorrect and explanation; if 'after_due_date', show 'Results available after [date]'; if 'never', show only score",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 12,
      "passes": true,
      "notes": "UX 3.5: Student Quiz Attempt is the most complex student-facing page. Timer, auto-save, question navigation, and results display. Keep auto-submit on timer expiry simple."
    },
    {
      "id": "US-064",
      "title": "Next.js Quiz Grading and Results pages",
      "description": "As a teacher, I need to review quiz attempts, manually grade essay questions, and view class-wide quiz analytics.",
      "acceptanceCriteria": [
        "Quiz Results page at /assess/quizzes/[quizId]/results: teacher/admin only, fetches GET /api/v1/quizzes/:quizId/results",
        "Summary stats: total attempts, average score, average percentage, highest/lowest score, completion rate",
        "Attempts table: student name (User #id), attempt number, score, percentage, status badge, submitted_at, 'Grade' link; sortable by score/name",
        "Filter by status: all, in_progress, submitted, graded",
        "Attempt Grading page at /assess/attempts/[attemptId]/grade: teacher view of single attempt",
        "Shows each question with: prompt, student answer, correct answer (if auto-gradable), is_correct indicator, points_awarded input (editable), feedback textarea",
        "Auto-graded questions show pre-filled points, teacher can override",
        "Essay questions have blank points field for teacher to fill",
        "Save Grades button: calls POST /api/v1/quiz_attempts/:id/grade_all",
        "Previous/Next attempt navigation for batch grading",
        "Back link to quiz results",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 13,
      "passes": true,
      "notes": "PRD-19: The analyze step. Teacher reviews results at quiz level (analytics) and attempt level (per-student grading). Batch navigation mirrors M3 Grading View."
    },
    {
      "id": "US-065",
      "title": "Next.js Quiz Accommodations management UI",
      "description": "As a teacher, I need to set per-student accommodations on a quiz so students with IEPs or 504 plans get appropriate support.",
      "acceptanceCriteria": [
        "Accommodations section added to Quiz Builder page (/assess/quizzes/[quizId]) as collapsible panel",
        "Lists accommodations (GET /api/v1/quizzes/:quizId/accommodations): student name, extra time, extra attempts, notes, edit/remove buttons",
        "Add form: student search/select dropdown, extra_time_minutes (number, default 0), extra_attempts (number, default 0), notes textarea; save calls POST",
        "Edit: inline edit, save calls PATCH /api/v1/quiz_accommodations/:id",
        "Remove: confirm dialog, calls DELETE",
        "Summary indicator: 'X students have accommodations' badge visible on quiz settings",
        "Only visible to teachers/admin",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 14,
      "passes": true,
      "notes": "PRD-12: Accommodations management integrated into quiz builder. Teachers set extra time/attempts per student without navigating away from quiz setup."
    },
    {
      "id": "US-066",
      "title": "Next.js QTI Import/Export UI",
      "description": "As a teacher, I need to import and export question banks in QTI format through the web interface so I can share assessment content.",
      "acceptanceCriteria": [
        "Export button on Question Bank Editor (/assess/banks/[bankId]): 'Export QTI' calls POST /api/v1/question_banks/:id/export_qti, shows spinner, polls GET /api/v1/question_banks/:id/export_qti_status every 2s until complete, then shows download link",
        "Import section on Bank Editor: file upload (.xml/.zip), 'Import QTI' calls POST with multipart form data, shows progress, on completion refreshes question list",
        "Import results: count imported, list of skipped/errored items from import_errors",
        "Also add Export/Import buttons to Question Bank List page (/assess/banks)",
        "Error handling: user-friendly message on import failure",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 15,
      "passes": true,
      "notes": "PRD-12: QTI import/export interoperability feature. Polling pattern for async export follows PDF export UX. Keep UI minimal — file picker for import, download link for export."
    }
  ]
}
