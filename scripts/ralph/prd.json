{
  "project": "k12-lms-platform",
  "branchName": "ralph/m3-lms-core",
  "description": "M3: LMS Core — Modules + Assignments + Submissions + Rubrics + Discussions per PRD-11 and PRD-25",
  "userStories": [
    {
      "id": "US-037",
      "title": "CourseModule and ModuleItem models with CRUD API",
      "description": "As a teacher, I need to organize course content into modules so students can navigate structured learning sequences.",
      "acceptanceCriteria": [
        "CourseModule model: id, tenant_id, course_id, title (string, required), description (text), position (integer, default 0), status (enum: draft, published, archived), unlock_at (datetime, optional), timestamps",
        "ModuleItem model: id, tenant_id, course_module_id, title (string, required), item_type (string, required: assignment, discussion, resource, url), itemable_type (string), itemable_id (bigint) — polymorphic, position (integer, default 0), timestamps",
        "Note: model is named CourseModule (not Module) to avoid Ruby keyword conflict; table is course_modules",
        "Both tenant-scoped with TenantScoped concern",
        "CourseModule belongs_to :course, has_many :module_items (dependent: :destroy)",
        "ModuleItem belongs_to :course_module, belongs_to :itemable (polymorphic, optional: true)",
        "CourseModule validates presence of title, status inclusion",
        "CourseModule has publish! (draft → published) and archive! (published → archived) methods",
        "Pundit policy: teacher enrolled in course can CRUD, admin can CRUD all, students can read published modules",
        "API endpoints: GET /api/v1/courses/:course_id/modules (list), POST /api/v1/courses/:course_id/modules (create), GET/PATCH/DELETE /api/v1/modules/:id, POST /api/v1/modules/:id/module_items, PATCH/DELETE /api/v1/module_items/:id, POST /api/v1/modules/:id/reorder_items",
        "Serializers for CourseModule and ModuleItem",
        "Request specs for CRUD, nested items, ordering, publish/archive, and authorization",
        "Rubocop passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "PRD-11: Modules are the top-level organizational unit for course delivery. Use 'CourseModule' as model name since 'Module' is reserved in Ruby. Course already exists from M1."
    },
    {
      "id": "US-038",
      "title": "Assignment model with CRUD API",
      "description": "As a teacher, I need to create assignments with due dates and submission requirements so students can complete and submit work.",
      "acceptanceCriteria": [
        "Assignment model: id, tenant_id, course_id (FK → courses), created_by_id (FK → users), title (string, required), description (text), instructions (text), assignment_type (string, required: written, file_upload, url, discussion), points_possible (decimal), due_at (datetime), unlock_at (datetime), lock_at (datetime), submission_types (text array, default []), allow_late_submission (boolean, default true), status (enum: draft, published, closed, archived), rubric_id (FK → rubrics, optional), timestamps",
        "Tenant-scoped with TenantScoped concern",
        "Assignment belongs_to :course, belongs_to :created_by (class_name: User), belongs_to :rubric (optional: true), has_many :submissions (dependent: :destroy)",
        "Validates: title presence, status inclusion, assignment_type inclusion, points_possible >= 0 if present",
        "publish! transitions draft → published, close! transitions published → closed, archive! transitions to archived",
        "Pundit policy: teacher enrolled in assignment's course can CRUD, admin can CRUD all, students can read published assignments in enrolled courses",
        "API endpoints: GET /api/v1/courses/:course_id/assignments (list with optional status filter), POST /api/v1/courses/:course_id/assignments (create), GET/PATCH/DELETE /api/v1/assignments/:id, POST /api/v1/assignments/:id/publish, POST /api/v1/assignments/:id/close",
        "Serializer includes course_id, rubric_id, created_by_id",
        "Request specs for CRUD, status transitions, filtering, and authorization",
        "Rubocop passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "PRD-11: Assignments are the core delivery artifact. Keep model lean — rubric_id is optional FK, file attachments handled via Active Storage on Submission."
    },
    {
      "id": "US-039",
      "title": "Submission model with submit and list API",
      "description": "As a student, I need to submit work for assignments so my teacher can review and grade it.",
      "acceptanceCriteria": [
        "Submission model: id, tenant_id, assignment_id (FK → assignments), user_id (FK → users), submission_type (string: text, url, file), body (text), url (string), status (enum: draft, submitted, graded, returned), submitted_at (datetime), attempt_number (integer, default 1), grade (decimal), graded_at (datetime), graded_by_id (FK → users, optional), feedback (text), timestamps",
        "Tenant-scoped with TenantScoped concern",
        "Submission belongs_to :assignment, belongs_to :user, belongs_to :graded_by (class_name: User, optional: true)",
        "Submission has_one_attached :attachment (Active Storage for file uploads)",
        "Unique constraint on (assignment_id, user_id) — one active submission per student per assignment",
        "Validates: status inclusion, grade <= assignment.points_possible when present",
        "submit! transitions draft → submitted (sets submitted_at), only if assignment is published and not past lock_at",
        "POST /api/v1/assignments/:assignment_id/submissions — student creates/submits (creates in submitted status)",
        "GET /api/v1/assignments/:assignment_id/submissions — teacher sees all submissions for assignment, student sees only own",
        "GET /api/v1/submissions/:id — show individual submission",
        "Pundit policy: students can create/view own submissions in enrolled courses, teachers can view all submissions for their course assignments, admin can view all",
        "Serializer includes assignment_id, user_id, status, grade, submitted_at",
        "Request specs for submit flow, authorization (student vs teacher vs wrong course), and file attachment",
        "Rubocop passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "PRD-11: Submissions connect students to assignments. Active Storage already configured from M1 (US-014). Keep one submission per student per assignment for simplicity."
    },
    {
      "id": "US-040",
      "title": "Submission grading and feedback API",
      "description": "As a teacher, I need to grade student submissions and provide feedback so students can learn from their work.",
      "acceptanceCriteria": [
        "POST /api/v1/submissions/:id/grade — sets grade (decimal), feedback (text), transitions status to 'graded', sets graded_at and graded_by_id",
        "POST /api/v1/submissions/:id/return — transitions status from 'graded' to 'returned' (makes feedback visible to student)",
        "Grade must be >= 0 and <= assignment.points_possible",
        "Feedback is optional text field",
        "Teacher can re-grade (update grade/feedback on already-graded submission)",
        "GET /api/v1/courses/:course_id/gradebook — returns all students in course with their submission grades per assignment (array of {user_id, assignment_id, grade, status})",
        "Gradebook scoped to teacher's enrolled course sections",
        "Pundit: only teachers enrolled in the assignment's course (or admin) can grade/return",
        "Students cannot access grade/return endpoints",
        "Request specs for grade flow, return flow, re-grade, gradebook, and authorization",
        "Rubocop passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "PRD-11, PRD-18: Grading workflow is grade → feedback → return. Gradebook gives teachers a course-level view of all grades."
    },
    {
      "id": "US-041",
      "title": "Rubric, RubricCriterion, and RubricRating models with CRUD API",
      "description": "As a teacher, I need to create reusable rubrics with criteria and scoring levels so I can grade consistently.",
      "acceptanceCriteria": [
        "Rubric model: id, tenant_id, created_by_id (FK → users), title (string, required), description (text), points_possible (decimal), timestamps",
        "RubricCriterion model: id, tenant_id, rubric_id (FK → rubrics), title (string, required), description (text), points (decimal, required), position (integer, default 0), timestamps",
        "RubricRating model: id, tenant_id, rubric_criterion_id (FK → rubric_criteria), description (string, required), points (decimal, required), position (integer, default 0), timestamps",
        "All three tenant-scoped with TenantScoped concern",
        "Rubric has_many :rubric_criteria (dependent: :destroy), belongs_to :created_by (User)",
        "RubricCriterion has_many :rubric_ratings (dependent: :destroy), belongs_to :rubric",
        "RubricRating belongs_to :rubric_criterion",
        "Rubric validates title presence; RubricCriterion validates points > 0; RubricRating validates points >= 0",
        "API: CRUD for /api/v1/rubrics, nested POST/PATCH/DELETE for /api/v1/rubrics/:id/criteria, nested POST/PATCH/DELETE for /api/v1/rubric_criteria/:id/ratings",
        "GET /api/v1/rubrics/:id returns rubric with nested criteria and ratings",
        "Pundit: teachers can CRUD own rubrics, admin can CRUD all, students can read rubrics attached to their assignments",
        "Request specs for full CRUD including nested creation and authorization",
        "Rubocop passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "PRD-11: Rubrics enable consistent grading. Keep the model simple — criterion has rating levels (e.g., Excellent=4, Good=3, Fair=2, Poor=1). points_possible on Rubric should equal sum of max criterion points."
    },
    {
      "id": "US-042",
      "title": "RubricScore API — apply rubric to submission",
      "description": "As a teacher, I need to score submissions using rubric criteria so grading is structured and transparent.",
      "acceptanceCriteria": [
        "RubricScore model: id, tenant_id, submission_id (FK → submissions), rubric_criterion_id (FK → rubric_criteria), rubric_rating_id (FK → rubric_ratings, optional), points_awarded (decimal, required), comments (text), timestamps",
        "Tenant-scoped with TenantScoped concern",
        "Unique constraint on (submission_id, rubric_criterion_id) — one score per criterion per submission",
        "RubricScore belongs_to :submission, belongs_to :rubric_criterion, belongs_to :rubric_rating (optional: true)",
        "POST /api/v1/submissions/:id/rubric_scores with { scores: [{rubric_criterion_id, rubric_rating_id, points_awarded, comments}] } — bulk creates/updates scores",
        "After scoring, auto-calculates total grade (sum of points_awarded) and updates submission.grade",
        "GET /api/v1/submissions/:id/rubric_scores — returns all scores for a submission with criterion and rating details",
        "Pundit: only teachers of the assignment's course (or admin) can create/view rubric scores",
        "Students can view rubric scores on their own returned submissions",
        "Request specs for bulk scoring, auto-grade calculation, and authorization",
        "Rubocop passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "PRD-11: Rubric scoring is the bridge between rubrics and submissions. Auto-calculate grade from rubric to avoid manual entry when rubric is used."
    },
    {
      "id": "US-043",
      "title": "Discussion and DiscussionPost models with CRUD API",
      "description": "As a teacher, I need to create threaded discussions so students can engage in course conversations.",
      "acceptanceCriteria": [
        "Discussion model: id, tenant_id, course_id (FK → courses), created_by_id (FK → users), title (string, required), description (text), status (enum: open, locked, archived), pinned (boolean, default false), require_initial_post (boolean, default false), timestamps",
        "DiscussionPost model: id, tenant_id, discussion_id (FK → discussions), parent_post_id (FK → discussion_posts, self-ref, optional), created_by_id (FK → users), content (text, required), timestamps",
        "Both tenant-scoped with TenantScoped concern",
        "Discussion belongs_to :course, belongs_to :created_by (User), has_many :discussion_posts (dependent: :destroy)",
        "DiscussionPost belongs_to :discussion, belongs_to :created_by (User), belongs_to :parent_post (class_name: DiscussionPost, optional: true), has_many :replies (class_name: DiscussionPost, foreign_key: :parent_post_id)",
        "Discussion validates title presence, status inclusion",
        "DiscussionPost validates content presence, cannot post to locked/archived discussions",
        "API: CRUD for /api/v1/courses/:course_id/discussions, nested POST /api/v1/discussions/:discussion_id/posts, GET /api/v1/discussions/:discussion_id/posts (returns threaded structure), DELETE /api/v1/discussion_posts/:id",
        "Pundit: teachers CRUD discussions, students read + post in enrolled courses, locked discussions block new posts",
        "Request specs for CRUD, threading, locked status blocking, and authorization",
        "Rubocop passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "PRD-11: Discussions are part of LMS Core. Self-referential parent_post_id enables threading. Keep scope manageable — no rating/voting in M3."
    },
    {
      "id": "US-044",
      "title": "Announcement model with CRUD API",
      "description": "As a teacher, I need to post announcements to my course so students stay informed.",
      "acceptanceCriteria": [
        "Announcement model: id, tenant_id, course_id (FK → courses), created_by_id (FK → users), title (string, required), message (text, required), published_at (datetime), pinned (boolean, default false), timestamps",
        "Tenant-scoped with TenantScoped concern",
        "Announcement belongs_to :course, belongs_to :created_by (User)",
        "Validates: title and message presence",
        "Scope: published (where published_at is not null and <= now), pinned_first (order by pinned DESC, published_at DESC)",
        "API: GET /api/v1/courses/:course_id/announcements (list, published only for students, all for teachers), POST /api/v1/courses/:course_id/announcements, PATCH/DELETE /api/v1/announcements/:id",
        "Pundit: teachers can CRUD announcements for their courses, admin can CRUD all, students can read published announcements",
        "Request specs for CRUD, publish filtering, and authorization",
        "Rubocop passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Announcements are a natural companion to course delivery. Simple model — no comments or reactions in M3."
    },
    {
      "id": "US-045",
      "title": "Next.js Teach section — Course List and Course Home pages",
      "description": "As a teacher or student, I need to see my enrolled courses and navigate to course content.",
      "acceptanceCriteria": [
        "Course List page at /teach/courses lists all courses the user is enrolled in (via enrollments → sections → courses)",
        "Each course card shows: name, code, section name, term, role (teacher/student)",
        "Course Home page at /teach/courses/[courseId] shows: course name, description, modules list, recent announcements, assignment summary",
        "Modules displayed as ordered cards with title, item count, status badge (draft/published)",
        "Teacher sees draft modules and 'New Module' button; student sees only published modules",
        "Recent announcements section (latest 3, pinned first)",
        "Upcoming assignments section (next 5 due)",
        "Update AppShell: Teach section gets sub-navigation with Courses and Submissions children",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 9,
      "passes": true,
      "notes": "PRD-11, UX §3.4: Course Home is the teacher/student entry point to LMS. Teach sub-nav mirrors Plan sub-nav pattern from M2."
    },
    {
      "id": "US-046",
      "title": "Next.js Module Editor page",
      "description": "As a teacher, I need to create and organize modules with items so students have a structured learning path.",
      "acceptanceCriteria": [
        "Module Editor page at /teach/courses/[courseId]/modules/[moduleId]",
        "Form fields: title, description, unlock date (optional)",
        "Module items list: ordered display with type icon, title, status",
        "Add item: button opens item type selector (assignment, discussion, URL resource)",
        "For assignment/discussion items: search and link existing items from the course",
        "For URL resource items: enter title + URL inline",
        "Reorder items via up/down buttons",
        "Remove item button (removes from module, does not delete the assignment/discussion)",
        "Publish/archive module buttons",
        "New module creation at /teach/courses/[courseId]/modules/new",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 10,
      "passes": true,
      "notes": "UX §3.4: Module Editor organizes content within a course. Items are links to assignments, discussions, or external URLs."
    },
    {
      "id": "US-047",
      "title": "Next.js Assignment Editor page",
      "description": "As a teacher, I need to create and edit assignments with grading settings so students know what to submit.",
      "acceptanceCriteria": [
        "Assignment Editor page at /teach/courses/[courseId]/assignments/[assignmentId]",
        "Form fields: title, description (textarea), instructions (textarea), assignment type (select), points possible (number), due date (datetime picker), unlock/lock dates (optional), submission types (multi-select: text, file, URL), allow late submission (checkbox)",
        "Rubric attachment section: search existing rubrics by title, attach/detach rubric",
        "If rubric attached, show rubric preview (criteria and ratings table)",
        "Publish and close buttons with status badge",
        "New assignment creation at /teach/courses/[courseId]/assignments/new",
        "Back navigation to course home",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 11,
      "passes": true,
      "notes": "PRD-11, UX §3.4: Assignment Editor is where teachers define student work. Rubric attachment is optional — inline rubric creation deferred to US-050."
    },
    {
      "id": "US-048",
      "title": "Next.js Student Assignment Submission page",
      "description": "As a student, I need to view assignment details and submit my work so I can complete course requirements.",
      "acceptanceCriteria": [
        "Student Submission page at /teach/courses/[courseId]/assignments/[assignmentId]/submit",
        "Displays: assignment title, description, instructions, due date, points possible, rubric preview (if attached)",
        "Submission area: text entry (textarea) if submission_type includes text, file upload if includes file, URL input if includes url",
        "Submit button (disabled after lock_at or if already submitted)",
        "After submission: shows confirmation with submitted_at timestamp and status badge",
        "If graded/returned: shows grade, feedback text, and rubric scores (if rubric-graded)",
        "Late submission warning shown if past due_at but before lock_at",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 12,
      "passes": true,
      "notes": "PRD-11, PRD-18: Student submission is the core LMS interaction. Keep it simple — one submission per student per assignment."
    },
    {
      "id": "US-049",
      "title": "Next.js Submissions Inbox page",
      "description": "As a teacher, I need to see all student submissions across my courses so I can manage grading efficiently.",
      "acceptanceCriteria": [
        "Submissions Inbox page at /teach/submissions",
        "Lists all submissions for courses the teacher is enrolled in",
        "Table columns: student name, assignment title, course name, submitted date, status badge, grade",
        "Filter by: course (dropdown), assignment (dropdown filtered by course), status (submitted/graded/returned)",
        "Search by student name (client-side filter)",
        "Summary stats at top: total pending, graded today, needs review",
        "Click submission row navigates to grading view (/teach/submissions/[submissionId]/grade)",
        "Empty state when no submissions match filters",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 13,
      "passes": true,
      "notes": "PRD-18: Submissions Inbox is the teacher's grading command center. Lists across all courses for efficiency."
    },
    {
      "id": "US-050",
      "title": "Next.js Grading View with rubric scoring",
      "description": "As a teacher, I need to view a submission and grade it using a rubric or manual entry so students get structured feedback.",
      "acceptanceCriteria": [
        "Grading View page at /teach/submissions/[submissionId]/grade",
        "Left panel: student submission content (text body, file download link, or URL link)",
        "Right panel: grading tools",
        "If rubric attached: rubric scoring interface — each criterion shown as a row with rating buttons, points awarded auto-fills from selected rating, optional per-criterion comments",
        "Total grade auto-calculated from rubric scores sum",
        "If no rubric: manual grade input (number field, max = points_possible)",
        "Feedback textarea (for overall comments)",
        "Save Grade button (calls POST /submissions/:id/grade or POST /submissions/:id/rubric_scores)",
        "Return to Student button (calls POST /submissions/:id/return)",
        "Navigation: previous/next submission buttons (within current assignment filter)",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 14,
      "passes": true,
      "notes": "PRD-11, PRD-18: Grading View is the most complex M3 page. Two modes: rubric-based (click ratings, auto-total) and manual (enter points). Save & navigate pattern for efficient batch grading."
    },
    {
      "id": "US-051",
      "title": "Next.js Discussion Board page",
      "description": "As a teacher or student, I need to participate in course discussions with threaded replies.",
      "acceptanceCriteria": [
        "Discussion List page at /teach/courses/[courseId]/discussions lists all discussions for the course",
        "Each discussion card shows: title, author, post count, status badge, pinned indicator",
        "Teacher sees 'New Discussion' button and draft discussions; student sees only open discussions",
        "Discussion Thread page at /teach/courses/[courseId]/discussions/[discussionId]",
        "Shows discussion title, description/prompt, and all posts in threaded view",
        "Posts display: author name, timestamp, content, reply button",
        "Nested replies indented under parent post (up to 3 levels, then flat)",
        "Reply form: textarea with submit button, shown inline when reply button clicked",
        "Teacher can lock/archive discussion (no new posts allowed)",
        "Locked discussions show read-only posts with lock indicator",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 15,
      "passes": true,
      "notes": "PRD-11: Discussions with threading. Keep it simple — no rating, no media uploads, no moderation queue in M3. Just text posts with threaded replies."
    }
  ]
}
