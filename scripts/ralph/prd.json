{
  "project": "k12-lms-platform",
  "branchName": "ralph/m2-planning-excellence",
  "description": "M2: Templates + Standards + Approvals — Phase 2 Planning Excellence per PRD-10 and PRD-25",
  "userStories": [
    {
      "id": "US-022",
      "title": "Template and TemplateVersion models with CRUD API",
      "description": "As a curriculum lead, I need reusable unit plan templates so teachers can start planning from proven structures.",
      "acceptanceCriteria": [
        "Template model: id, tenant_id, name, subject, grade_level, description, created_by_id, status (enum: draft, published, archived), timestamps",
        "TemplateVersion model: id, tenant_id, template_id, version_number, title, description, essential_questions (text array), enduring_understandings (text array), suggested_duration_weeks (integer), timestamps",
        "Both tenant-scoped with TenantScoped concern",
        "Template has_many template_versions, belongs_to current_version (optional)",
        "Auto-increment version_number like UnitVersion pattern",
        "Pundit policy: admin/curriculum_lead can CRUD, teachers can read published templates",
        "API endpoints: CRUD for templates, create_version, list versions under /api/v1/templates",
        "Request specs for CRUD, versioning, and authorization",
        "Rubocop passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "PRD-10: Templates are Phase 2 core. Follow exact same versioning pattern as UnitPlan/UnitVersion from M1."
    },
    {
      "id": "US-023",
      "title": "Template standards alignment",
      "description": "As a curriculum lead, I need to attach standards to templates so units created from them inherit alignment.",
      "acceptanceCriteria": [
        "TemplateVersionStandard join model: template_version_id, standard_id, tenant_id",
        "TemplateVersion has_many standards through template_version_standards",
        "API endpoint: POST/DELETE /api/v1/template_versions/:id/standards to attach/detach",
        "GET /api/v1/template_versions/:id/standards lists aligned standards",
        "Validation: standard_id unique per template_version_id",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Mirrors UnitVersionStandard pattern. Standards carry over when creating unit from template."
    },
    {
      "id": "US-024",
      "title": "Create unit plan from template",
      "description": "As a teacher, I need to create a new unit plan from a template so I start with a pre-filled structure.",
      "acceptanceCriteria": [
        "API endpoint: POST /api/v1/templates/:id/create_unit with params { course_id }",
        "Creates new UnitPlan in draft status, copies template version fields (title, description, essential_questions, enduring_understandings) into first UnitVersion",
        "Copies aligned standards from TemplateVersionStandard to UnitVersionStandard",
        "Returns the created UnitPlan with its first version",
        "Only published templates can be used to create units",
        "Pundit: any teacher/curriculum_lead/admin can use a published template",
        "Request specs verify field copying, standards copying, and authorization",
        "Rubocop passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "PRD-10, PRD-17: Templates reduce time-to-first-unit. This is the critical bridge between templates and units."
    },
    {
      "id": "US-025",
      "title": "Unit version standards management API",
      "description": "As a teacher, I need to bulk-manage standards aligned to my unit versions via API.",
      "acceptanceCriteria": [
        "POST /api/v1/unit_versions/:id/standards with { standard_ids: [...] } bulk-attaches standards",
        "DELETE /api/v1/unit_versions/:id/standards with { standard_ids: [...] } bulk-detaches standards",
        "GET /api/v1/unit_versions/:id/standards returns all aligned standards with code, description, grade_band",
        "Idempotent: attaching already-attached standard does not error",
        "Pundit: only unit owner or admin can modify standards alignment",
        "Request specs for attach, detach, idempotency, and authorization",
        "Rubocop passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "M1 created UnitVersionStandard join model but no API. This story adds the API layer for standards management."
    },
    {
      "id": "US-026",
      "title": "Standards coverage reporting API",
      "description": "As a curriculum lead, I need to see which standards are covered across units in a course so I can identify gaps.",
      "acceptanceCriteria": [
        "GET /api/v1/courses/:id/standards_coverage returns list of standards with coverage data",
        "Each standard entry includes: standard_id, code, description, grade_band, covered (boolean), unit_plan_ids (array of unit plan IDs covering it)",
        "Coverage scoped to a specific standard_framework_id query param",
        "Only counts standards from published or draft unit versions (not archived)",
        "GET /api/v1/academic_years/:id/standards_coverage returns coverage across all courses in that year",
        "Pundit: admin/curriculum_lead can access coverage reports",
        "Request specs with multi-unit, multi-course scenarios",
        "Rubocop passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "PRD-10: Coverage reporting lets curriculum leads see gaps. This is the data API — frontend visualization in US-035."
    },
    {
      "id": "US-027",
      "title": "Approval model and workflow",
      "description": "As a curriculum lead, I need an optional approval workflow so units are reviewed before publishing.",
      "acceptanceCriteria": [
        "Approval model: id, tenant_id, approvable_type, approvable_id (polymorphic), status (enum: pending, approved, rejected), requested_by_id, reviewed_by_id, comments (text), reviewed_at (datetime), timestamps",
        "Tenant settings: approval_required (boolean, default false) stored in tenant.settings jsonb",
        "Approval is tenant-scoped",
        "Status transitions: pending → approved, pending → rejected",
        "Polymorphic: works with UnitPlan (extensible to other models later)",
        "Model validations and specs",
        "Rubocop passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "PRD-10: Optional approvals. The model is generic (polymorphic) but Phase 2 only uses it with UnitPlan."
    },
    {
      "id": "US-028",
      "title": "Approval API endpoints and publish integration",
      "description": "As a curriculum lead, I need API endpoints to submit, review, and list approvals, integrated with the publish pipeline.",
      "acceptanceCriteria": [
        "POST /api/v1/unit_plans/:id/submit_for_approval creates a pending Approval (only when tenant.settings.approval_required is true)",
        "When approval is not required, publish works directly as before (no behavior change)",
        "GET /api/v1/approvals lists pending approvals (admin/curriculum_lead only)",
        "GET /api/v1/approvals?status=pending|approved|rejected supports filtering",
        "POST /api/v1/approvals/:id/approve transitions to approved, auto-publishes the unit plan",
        "POST /api/v1/approvals/:id/reject transitions to rejected with required comments",
        "UnitPlan status adds 'pending_approval' to VALID_STATUSES",
        "Publish endpoint returns 422 when approval is required but not yet approved",
        "Pundit: teachers submit, admin/curriculum_lead review",
        "Request specs for full approval flow, bypass when not required, and authorization",
        "Rubocop passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "PRD-10: Approvals gate publishing. When tenant has approval_required=false, publish works exactly as M1."
    },
    {
      "id": "US-029",
      "title": "Next.js Template Library page",
      "description": "As a teacher, I need to browse and search templates so I can find one to start my unit plan from.",
      "acceptanceCriteria": [
        "Template Library page at /plan/templates",
        "Lists all published templates for the tenant",
        "Filter by: subject, grade level",
        "Search by title (client-side filter)",
        "Each template card shows: name, subject, grade level, description preview",
        "'Use Template' button navigates to create-unit-from-template flow",
        "Admin/curriculum_lead see a 'Create Template' button",
        "Add 'Templates' sub-nav item under Plan section in AppShell",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 8,
      "passes": false,
      "notes": "UX §3.4: Template Library. Teachers browse, curriculum leads manage."
    },
    {
      "id": "US-030",
      "title": "Next.js Template Editor page",
      "description": "As a curriculum lead, I need to create and edit templates so teachers have good starting points.",
      "acceptanceCriteria": [
        "Template Editor page at /plan/templates/:id",
        "Form fields: name, subject, grade level, description, essential questions (multi-input), enduring understandings (multi-input), suggested duration weeks",
        "Save creates a new template version",
        "Standards alignment section: search and attach standards (same UX as Unit Planner)",
        "Publish/archive template buttons for curriculum lead/admin",
        "Version history displayed",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 9,
      "passes": false,
      "notes": "UX §3.4: Template editor mirrors Unit Planner UX. Only curriculum_lead and admin can access."
    },
    {
      "id": "US-031",
      "title": "Next.js create unit from template flow",
      "description": "As a teacher, I need to select a template and create a new unit plan from it in one step.",
      "acceptanceCriteria": [
        "From Template Library, 'Use Template' opens a modal or page to select a course",
        "On confirm, calls POST /api/v1/templates/:id/create_unit with selected course_id",
        "Redirects to the Unit Planner page for the newly created unit",
        "Shows success toast/notification",
        "Error handling if template is no longer published",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 10,
      "passes": false,
      "notes": "PRD-8: Time-to-first-unit < 20 minutes. This is the fastest path to creating a unit."
    },
    {
      "id": "US-032",
      "title": "Next.js Standards Browser page",
      "description": "As a teacher, I need to browse standards frameworks and view the full standards tree.",
      "acceptanceCriteria": [
        "Standards Browser page at /plan/standards",
        "Lists all standard frameworks with name, subject, jurisdiction",
        "Click a framework to see its full standards tree (nested, expandable)",
        "Each standard shows code, description, grade band",
        "Shows which units reference each standard (linked unit titles)",
        "Search/filter standards by code or description",
        "Add 'Standards' sub-nav item under Plan section in AppShell",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 11,
      "passes": false,
      "notes": "UX §3.4: Standards Browser. Helps teachers explore and understand available standards."
    },
    {
      "id": "US-033",
      "title": "Next.js Unit Planner standards alignment enhancement",
      "description": "As a teacher, I need the Unit Planner to save and load aligned standards so alignment persists across versions.",
      "acceptanceCriteria": [
        "Unit Planner (/plan/units/[id]) loads aligned standards from GET /api/v1/unit_versions/:id/standards",
        "Adding a standard calls POST to attach it to the current version",
        "Removing a standard calls DELETE to detach it",
        "Standards persist across page refreshes (stored server-side, not just in local state)",
        "Standards displayed as chips with remove button",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 12,
      "passes": false,
      "notes": "M1 Unit Planner had client-side-only standards selection. This wires it to the real API."
    },
    {
      "id": "US-034",
      "title": "Next.js Publish Preview page",
      "description": "As a teacher, I need to preview my unit plan before publishing so I can verify content and alignment.",
      "acceptanceCriteria": [
        "Publish Preview page at /plan/units/[id]/preview",
        "Displays read-only view of: title, description, essential questions, enduring understandings",
        "Shows aligned standards list with codes and descriptions",
        "Shows lesson list with titles and objectives",
        "Shows resource links",
        "Prominent 'Publish' or 'Submit for Approval' button (depending on tenant settings)",
        "Back button returns to Unit Planner",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 13,
      "passes": false,
      "notes": "UX §3.4: Publish Preview. Final checkpoint before publishing or submitting for approval."
    },
    {
      "id": "US-035",
      "title": "Next.js Curriculum Map — standards coverage",
      "description": "As a curriculum lead, I need a visual curriculum map showing which standards are covered across courses.",
      "acceptanceCriteria": [
        "Curriculum Map page at /admin/curriculum-map",
        "Select academic year and standard framework to view",
        "Displays a matrix: rows = standards, columns = courses",
        "Cells show coverage status: covered (green), gap (red/empty)",
        "Click a cell to see which unit plans cover that standard in that course",
        "Summary stats: total standards, covered count, coverage percentage",
        "Only accessible to admin and curriculum_lead roles",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 14,
      "passes": false,
      "notes": "PRD-10, UX §3.6: Curriculum Map. The key visibility tool for curriculum leads."
    },
    {
      "id": "US-036",
      "title": "Next.js Approval Queue page",
      "description": "As a curriculum lead, I need to review and approve/reject unit plans submitted for approval.",
      "acceptanceCriteria": [
        "Approval Queue page at /admin/approvals",
        "Lists all pending approvals with: unit title, submitted by, submitted date",
        "Click to view full unit preview (reuses Publish Preview layout)",
        "Approve button: approves and auto-publishes the unit",
        "Reject button: opens comments field, requires reason, rejects approval",
        "Filter by status: pending, approved, rejected",
        "Only accessible to admin and curriculum_lead roles",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 15,
      "passes": false,
      "notes": "PRD-10, UX §3.6: Approval Queue. Only visible when tenant has approval_required enabled."
    }
  ]
}
