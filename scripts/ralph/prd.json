{
  "project": "k12-lms-platform",
  "branchName": "ralph/m1-foundation",
  "description": "M1: Auth + Tenancy + Planner Core — Phase 1 Foundation per PRD-9 and PRD-25",
  "userStories": [
    {
      "id": "US-001",
      "title": "Initialize Rails API app with core gems",
      "description": "As a developer, I need the Rails API-only app scaffolded so all subsequent stories have a working backend.",
      "acceptanceCriteria": [
        "Rails 7+ API-only app created in apps/core",
        "Gemfile includes: pg, devise, omniauth, omniauth-google-oauth2, pundit, sidekiq, active_model_serializers, rack-cors, rubocop-rails",
        "Database.yml configured for Postgres",
        "bundle install succeeds",
        "rails db:create succeeds",
        "RSpec is configured and a trivial test passes",
        "Rubocop runs clean"
      ],
      "priority": 1,
      "passes": true,
      "notes": "API-only mode. No views. Postgres required."
    },
    {
      "id": "US-002",
      "title": "Initialize Next.js frontend app",
      "description": "As a developer, I need the Next.js frontend scaffolded so UI stories can be built.",
      "acceptanceCriteria": [
        "Next.js 14+ app created in apps/web with TypeScript",
        "Tailwind CSS configured",
        "ESLint and Prettier configured",
        "npm run lint passes",
        "npm run build succeeds",
        "Basic layout component exists with left nav placeholder matching UX §3.2 structure"
      ],
      "priority": 2,
      "passes": true,
      "notes": "App Router preferred. TypeScript strict mode."
    },
    {
      "id": "US-003",
      "title": "Tenant and School models with multi-tenancy",
      "description": "As a platform operator, I need tenant isolation so each school's data is separate.",
      "acceptanceCriteria": [
        "Tenant model with: id, name, slug, settings (jsonb), timestamps",
        "School model with: id, tenant_id, name, address, timezone, timestamps",
        "tenant_id column on schools table with NOT NULL and index",
        "ApplicationRecord includes a concern that scopes all queries by Current.tenant",
        "Migration runs successfully",
        "Model specs verify tenant scoping",
        "Rubocop passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Use Current attributes (ActiveSupport::CurrentAttributes) for tenant context. This is the foundation — every future model inherits tenant scoping."
    },
    {
      "id": "US-004",
      "title": "User model, Roles, and RBAC with Pundit",
      "description": "As an admin, I need role-based access so teachers, students, and admins have appropriate permissions.",
      "acceptanceCriteria": [
        "User model with: id, tenant_id, email, first_name, last_name, timestamps",
        "Role model with: id, tenant_id, name (enum: admin, curriculum_lead, teacher, student, guardian)",
        "UserRole join model with: user_id, role_id, tenant_id",
        "Pundit configured with ApplicationPolicy base class",
        "Users are tenant-scoped",
        "RSpec tests for role assignment and policy checks",
        "Rubocop passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "PRD-3 defines four primary user types. Guardian is optional per PRD-4."
    },
    {
      "id": "US-005",
      "title": "OmniAuth Google OIDC authentication",
      "description": "As a user, I need to sign in with Google so I can access the platform securely.",
      "acceptanceCriteria": [
        "OmniAuth Google OAuth2 strategy configured",
        "Sessions controller handles callback, creates/finds user by email within tenant",
        "Short-lived access token + refresh token stored (or session cookie + CSRF)",
        "Sign-out endpoint clears session",
        "Unauthenticated requests return 401 JSON",
        "Request specs verify auth flow",
        "Rubocop passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Tech Spec §2.3. Google OIDC is primary auth. SAML can come later."
    },
    {
      "id": "US-006",
      "title": "API authentication middleware and tenant resolution",
      "description": "As a developer, I need every API request to resolve the tenant and authenticate the user so all downstream code is scoped.",
      "acceptanceCriteria": [
        "ApplicationController before_action sets Current.user and Current.tenant",
        "Tenant resolved from subdomain, header, or token claim",
        "All /api/v1 routes require authentication",
        "Pundit authorization enforced on all actions",
        "Request spec: unauthenticated returns 401",
        "Request spec: wrong tenant returns 403",
        "Rubocop passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "This is the security backbone. Every controller inherits this."
    },
    {
      "id": "US-007",
      "title": "AcademicYear and Term models",
      "description": "As a curriculum lead, I need academic years and terms so units can be organized by time period.",
      "acceptanceCriteria": [
        "AcademicYear model: id, tenant_id, name, start_date, end_date, current (boolean)",
        "Term model: id, tenant_id, academic_year_id, name, start_date, end_date",
        "Both tenant-scoped",
        "Validations: dates required, end > start",
        "API endpoints: CRUD for both under /api/v1/academic_years and /api/v1/terms",
        "Request specs for CRUD + authorization",
        "Rubocop passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Tech Spec §2.4 Identity/Organization group."
    },
    {
      "id": "US-008",
      "title": "Course and Section models with enrollments",
      "description": "As a teacher, I need courses and sections so I can organize my classes.",
      "acceptanceCriteria": [
        "Course model: id, tenant_id, name, code, description, academic_year_id, timestamps",
        "Section model: id, tenant_id, course_id, name, term_id, timestamps",
        "Enrollment model: id, tenant_id, user_id, section_id, role (enum: teacher, student), timestamps",
        "All tenant-scoped",
        "API endpoints: CRUD for courses, sections, enrollments under /api/v1",
        "Enrollment enforces one role per user per section",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Tech Spec §2.4. Enrollments connect users to sections with a role."
    },
    {
      "id": "US-009",
      "title": "StandardFramework and Standard models",
      "description": "As a curriculum lead, I need to manage standards frameworks so teachers can align units to standards.",
      "acceptanceCriteria": [
        "StandardFramework model: id, tenant_id, name, jurisdiction, subject, version, timestamps",
        "Standard model: id, tenant_id, standard_framework_id, parent_id (self-referential tree), code, description, grade_band, timestamps",
        "Both tenant-scoped",
        "Standard supports hierarchical nesting (parent_id)",
        "API endpoints: CRUD + tree traversal endpoint",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "PRD-5, PRD-10: standards alignment is critical to planning. Tree structure for nested standards."
    },
    {
      "id": "US-010",
      "title": "UnitPlan and UnitVersion models with versioning",
      "description": "As a teacher, I need to create unit plans with version history so I can iterate on my planning.",
      "acceptanceCriteria": [
        "UnitPlan model: id, tenant_id, course_id, created_by_id, title, status (enum: draft, published, archived), timestamps",
        "UnitVersion model: id, tenant_id, unit_plan_id, version_number, title, description, essential_questions (text array), enduring_understandings (text array), timestamps",
        "Creating a new version auto-increments version_number",
        "UnitPlan has_many unit_versions, belongs_to current_version",
        "Standards can be linked to UnitVersion via join table (unit_version_standards)",
        "API endpoints: CRUD for unit_plans, create new version, list versions",
        "Request specs verify versioning logic",
        "Rubocop passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "PRD-9, PRD-17: versioning is core to Phase 1. Teacher creates unit, each save creates a new version."
    },
    {
      "id": "US-011",
      "title": "LessonPlan and LessonVersion models with versioning",
      "description": "As a teacher, I need lesson plans within units so I can plan day-by-day instruction.",
      "acceptanceCriteria": [
        "LessonPlan model: id, tenant_id, unit_plan_id, created_by_id, title, position (integer for ordering), status (enum: draft, published), timestamps",
        "LessonVersion model: id, tenant_id, lesson_plan_id, version_number, title, objectives (text), activities (text), materials (text), duration_minutes (integer), timestamps",
        "Versioning works same as UnitVersion",
        "Lessons ordered by position within a unit",
        "API endpoints: CRUD nested under unit_plans",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "PRD-9, PRD-17. Lessons are children of units. Position field for drag-reorder later."
    },
    {
      "id": "US-012",
      "title": "ResourceLink model for Drive attachments",
      "description": "As a teacher, I need to attach Google Drive files to units and lessons so my resources are linked.",
      "acceptanceCriteria": [
        "ResourceLink model: id, tenant_id, linkable_type, linkable_id (polymorphic), url, title, mime_type, drive_file_id, provider (enum: google_drive, upload, url), timestamps",
        "Polymorphic association works with UnitVersion and LessonVersion",
        "API endpoint: create/delete resource links on a unit_version or lesson_version",
        "Validation: URL format, drive_file_id present when provider=google_drive",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "PRD-9, PRD-20: Drive attachments are Phase 1. Actual Google API integration is Phase 5 — this is the data model and linking only."
    },
    {
      "id": "US-013",
      "title": "Publish pipeline for units",
      "description": "As a teacher, I need to publish a unit so it becomes visible to students and locked from edits.",
      "acceptanceCriteria": [
        "UnitPlan status transitions: draft → published, published → archived",
        "Publishing locks the current version (no further edits to that version)",
        "Published units are visible in course context",
        "Only unit owner or admin can publish",
        "Pundit policy enforces publish permission",
        "API endpoint: POST /api/v1/unit_plans/:id/publish",
        "Request specs for publish flow and authorization",
        "Rubocop passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "PRD-17: publish is the final step in the teacher planning workflow."
    },
    {
      "id": "US-014",
      "title": "PDF export for unit plans",
      "description": "As a teacher, I need to export a unit plan as PDF so I can share it offline.",
      "acceptanceCriteria": [
        "Sidekiq job generates PDF from unit plan + current version + lessons",
        "PDF includes: title, description, essential questions, enduring understandings, lesson titles and objectives, linked standards",
        "API endpoint: POST /api/v1/unit_plans/:id/export_pdf returns job ID",
        "GET endpoint to check status and download signed URL",
        "Active Storage stores the generated PDF",
        "Job is idempotent",
        "Request specs",
        "Rubocop passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "PRD-9: PDF export is Phase 1. Use Prawn or Grover gem for generation."
    },
    {
      "id": "US-015",
      "title": "Next.js auth flow — Google sign-in and session",
      "description": "As a user, I need to sign in from the web app so I can access my dashboard.",
      "acceptanceCriteria": [
        "Sign-in page with Google OAuth button (UX §3.3)",
        "OAuth redirect flow to Rails backend",
        "Access token stored in httpOnly cookie or secure storage",
        "Authenticated API client utility (fetch wrapper with token)",
        "Redirect to dashboard on success, error state on failure",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 15,
      "passes": false,
      "notes": "UX §3.3: Sign in → School selection → First-time setup. Start with just sign-in."
    },
    {
      "id": "US-016",
      "title": "Next.js App Shell — left nav and layout",
      "description": "As a user, I need the main app layout so I can navigate between sections.",
      "acceptanceCriteria": [
        "App shell layout with left sidebar nav matching UX §3.2",
        "Nav items: Plan, Teach, Assess, Report, Communicate, Admin",
        "Top bar with school name placeholder, search placeholder, notification bell placeholder",
        "Active nav state highlighted",
        "Responsive: sidebar collapses on mobile",
        "Protected route wrapper redirects unauthenticated users",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 16,
      "passes": false,
      "notes": "UX §3.2. This is the chrome around all authenticated pages."
    },
    {
      "id": "US-017",
      "title": "Next.js Teacher Dashboard page",
      "description": "As a teacher, I need a dashboard so I can see my units and courses at a glance.",
      "acceptanceCriteria": [
        "Dashboard page at /dashboard",
        "Fetches and displays: recent unit plans, enrolled courses/sections",
        "Empty states when no data exists",
        "Links to unit planner and course home",
        "Uses API client from US-015",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 17,
      "passes": false,
      "notes": "UX §3.4: Teacher Dashboard. Keep it simple — cards for recent units, list of courses."
    },
    {
      "id": "US-018",
      "title": "Next.js Unit Library page",
      "description": "As a teacher, I need to browse and search my unit plans so I can find and manage them.",
      "acceptanceCriteria": [
        "Unit Library page at /plan/units",
        "Lists all unit plans for current user's courses",
        "Filter by: course, status (draft/published/archived)",
        "Search by title (client-side filter is fine for now)",
        "Create new unit button → navigates to unit planner",
        "Each unit card shows: title, course, status badge, version count",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 18,
      "passes": false,
      "notes": "UX §3.4: Unit Library. This is under the Plan nav section."
    },
    {
      "id": "US-019",
      "title": "Next.js Unit Planner page with version editing",
      "description": "As a teacher, I need to create and edit unit plans so I can do my core planning work.",
      "acceptanceCriteria": [
        "Unit Planner page at /plan/units/:id",
        "Form fields: title, description, essential questions (multi-input), enduring understandings (multi-input)",
        "Save creates a new version (version number displayed)",
        "Version history sidebar or dropdown showing past versions",
        "Standards alignment section: search and attach standards",
        "Lesson list section showing ordered lessons with add/reorder",
        "Publish button (calls publish endpoint)",
        "Right context panel placeholder per UX §3.2",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 19,
      "passes": false,
      "notes": "UX §3.4: Unit Planner. This is the most important screen in the app. PRD-17 workflow lives here."
    },
    {
      "id": "US-020",
      "title": "Next.js Lesson Editor page",
      "description": "As a teacher, I need to edit individual lessons within a unit so I can plan day-by-day.",
      "acceptanceCriteria": [
        "Lesson Editor page at /plan/units/:unitId/lessons/:lessonId",
        "Form fields: title, objectives, activities (rich text or textarea), materials, duration",
        "Save creates new lesson version",
        "Resource links section: add Drive link (URL input for now), list attached resources",
        "Back navigation to unit planner",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 20,
      "passes": false,
      "notes": "UX §3.4: Lesson Editor. Keep it clean. Actual Drive picker integration is Phase 5."
    },
    {
      "id": "US-021",
      "title": "Seed data script for development and demos",
      "description": "As a developer, I need seed data so I can test the full flow without manual setup.",
      "acceptanceCriteria": [
        "db/seeds.rb creates: 1 tenant, 1 school, 1 academic year with 2 terms",
        "Creates users: 1 admin, 2 teachers, 3 students with appropriate roles",
        "Creates 2 courses with sections and enrollments",
        "Creates 1 standard framework with ~10 nested standards",
        "Creates 2 unit plans with versions, lessons, and resource links",
        "Seed is idempotent (can run multiple times)",
        "rails db:seed completes without error",
        "Rubocop passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": "This makes demos and testing possible. Run last since it depends on all models."
    }
  ]
}
