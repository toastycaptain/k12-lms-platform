{
  "project": "k12-lms-platform",
  "branchName": "ralph/m5-google-integrations",
  "description": "M5: Google Integrations — Workspace Add-ons + Classroom Sync + Drive Integration per PRD-13, PRD-20, and PRD-25",
  "userStories": [
    {
      "id": "US-067",
      "title": "IntegrationConfig model with CRUD API",
      "description": "As an admin, I need to configure per-tenant integration settings for Google Classroom and Drive so the platform can connect to Google services.",
      "acceptanceCriteria": [
        "IntegrationConfig model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), provider (string, NOT NULL), status (string, NOT NULL, default 'inactive'), settings (jsonb, NOT NULL, default {}), created_by_id (FK → users, NOT NULL), timestamps",
        "VALID_PROVIDERS = %w[google_classroom].freeze",
        "VALID_STATUSES = %w[inactive active error].freeze",
        "Migration: create_integration_configs table with t.references :tenant, null: false, foreign_key: true, index: true; t.string :provider, null: false; t.string :status, null: false, default: 'inactive'; t.jsonb :settings, null: false, default: {}; t.references :created_by, null: false, foreign_key: { to_table: :users }; t.timestamps; add_index :integration_configs, [:tenant_id, :provider], unique: true",
        "Include TenantScoped concern",
        "belongs_to :created_by, class_name: 'User'",
        "has_many :sync_runs, dependent: :destroy",
        "has_many :sync_mappings, dependent: :destroy",
        "Validates: provider presence and inclusion in VALID_PROVIDERS, status presence and inclusion in VALID_STATUSES, uniqueness of provider scoped to tenant_id",
        "Settings JSONB stores: { classroom_enabled: bool, drive_enabled: bool, auto_sync_enabled: bool, sync_interval_hours: int, domain: string }",
        "activate! method: transitions inactive/error → active (validates settings has required fields); deactivate! method: sets status to inactive",
        "Pundit IntegrationConfigPolicy: index? returns user.has_role?(:admin); show? same; create? same; update? same; destroy? same; Scope resolves scope.all for admin, scope.none for others",
        "IntegrationConfigSerializer: attributes :id, :tenant_id, :provider, :status, :settings, :created_by_id, :created_at, :updated_at",
        "API routes: GET /api/v1/integration_configs (index), POST /api/v1/integration_configs (create), GET /api/v1/integration_configs/:id (show), PATCH /api/v1/integration_configs/:id (update), DELETE /api/v1/integration_configs/:id (destroy), POST /api/v1/integration_configs/:id/activate (member), POST /api/v1/integration_configs/:id/deactivate (member)",
        "Controller: Api::V1::IntegrationConfigsController with before_action :set_integration_config for show/update/destroy/activate/deactivate; create sets tenant via Current.tenant and created_by via Current.user; authorize called on every action; index uses policy_scope",
        "Factory :integration_config with association :tenant, association :created_by (factory: :user), provider 'google_classroom', status 'inactive', settings { classroom_enabled: true, drive_enabled: true, auto_sync_enabled: false, sync_interval_hours: 24, domain: 'school.edu' }",
        "Request specs: list as admin (200), list as teacher (403), create, show, update settings, delete, activate, deactivate, duplicate provider per tenant (422), Rubocop passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "PRD-13, Tech Spec 2.4: IntegrationConfig is the per-tenant configuration hub for Google integrations. One config per provider per tenant. Settings JSONB allows flexible configuration without schema changes. Admin-only access."
    },
    {
      "id": "US-068",
      "title": "Google OAuth token storage and refresh service",
      "description": "As a user, I need my Google OAuth tokens stored securely so the platform can make API calls to Google Classroom and Drive on my behalf.",
      "acceptanceCriteria": [
        "Migration: add columns to users table — t.text :google_access_token; t.text :google_refresh_token; t.datetime :google_token_expires_at",
        "User model: add encrypts :google_access_token, :google_refresh_token (Rails 8 encrypted attributes)",
        "Update OmniAuth callback in SessionsController#omniauth_callback to store tokens: user.update!(google_access_token: auth.credentials.token, google_refresh_token: auth.credentials.refresh_token, google_token_expires_at: Time.at(auth.credentials.expires_at)) when auth.credentials present",
        "Only update google_refresh_token if a new one is provided (refresh tokens are not always returned on subsequent logins)",
        "Update OmniAuth initializer scope to include Classroom and Drive scopes: 'email,profile,https://www.googleapis.com/auth/classroom.courses.readonly,https://www.googleapis.com/auth/classroom.coursework.students,https://www.googleapis.com/auth/classroom.rosters.readonly,https://www.googleapis.com/auth/drive.file' — but only when GOOGLE_CLASSROOM_ENABLED env var is 'true' (default to basic scopes otherwise)",
        "Add access_type: 'offline' to OmniAuth provider config to get refresh tokens",
        "GoogleTokenService class in app/services/google_token_service.rb: initialize(user), valid_token? checks google_token_expires_at > 5.minutes.from_now, refresh! uses googleauth gem to exchange refresh_token for new access_token and updates user record, access_token method returns valid token (refreshing if needed)",
        "Add google-apis-core gem to Gemfile (provides Google::Auth::UserRefreshCredentials for token refresh)",
        "GoogleTokenService#credentials returns a Google::Auth::UserRefreshCredentials configured with client_id, client_secret, refresh_token, access_token from user — usable by google-apis-* gems directly",
        "Do NOT include google_access_token or google_refresh_token in UserSerializer (security)",
        "Add google_connected? method to User model: returns google_refresh_token.present?",
        "GET /api/v1/me response already includes user data — add google_connected (boolean) field to the response",
        "Service specs: GoogleTokenService with valid token returns it, with expired token refreshes (stub Google API), with no refresh token raises error",
        "Request specs: OmniAuth callback stores tokens (mock auth hash with credentials), /api/v1/me returns google_connected boolean, Rubocop passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "PRD-13, PRD-20: Token storage is the foundation for all Google API calls. Encrypted attributes protect tokens at rest. The conditional scope expansion ensures basic auth still works without Classroom/Drive. GoogleTokenService wraps token refresh logic for reuse across all Google service objects."
    },
    {
      "id": "US-069",
      "title": "SyncMapping model with CRUD API",
      "description": "As an admin, I need mappings between local LMS entities and their Google Classroom counterparts so the platform tracks which courses, assignments, and enrollments are synced.",
      "acceptanceCriteria": [
        "SyncMapping model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), integration_config_id (FK → integration_configs, NOT NULL, indexed), local_type (string, NOT NULL), local_id (bigint, NOT NULL), external_id (string, NOT NULL), external_type (string, NOT NULL), metadata (jsonb, NOT NULL, default {}), last_synced_at (datetime), timestamps",
        "VALID_LOCAL_TYPES = %w[Course Section Enrollment Assignment Submission].freeze",
        "VALID_EXTERNAL_TYPES = %w[classroom_course classroom_section classroom_student classroom_coursework classroom_submission].freeze",
        "Migration: create_sync_mappings table with all columns; add_index :sync_mappings, [:integration_config_id, :local_type, :local_id], unique: true, name: 'idx_sync_mappings_local_unique'; add_index :sync_mappings, [:integration_config_id, :external_type, :external_id], unique: true, name: 'idx_sync_mappings_external_unique'",
        "Include TenantScoped concern",
        "belongs_to :integration_config",
        "Validates: local_type presence and inclusion in VALID_LOCAL_TYPES, external_type presence and inclusion in VALID_EXTERNAL_TYPES, external_id presence, uniqueness of local_id scoped to [:integration_config_id, :local_type], uniqueness of external_id scoped to [:integration_config_id, :external_type]",
        "Scope :for_local — where(local_type: type, local_id: id)",
        "Scope :for_external — where(external_type: type, external_id: id)",
        "find_local(integration_config, local_type, local_id) class method returns mapping or nil",
        "find_external(integration_config, external_type, external_id) class method returns mapping or nil",
        "Pundit SyncMappingPolicy: index? returns user.has_role?(:admin) || user.has_role?(:teacher); show? same; create? admin only; destroy? admin only; Scope: admin sees all, teacher sees own course mappings",
        "SyncMappingSerializer: attributes :id, :tenant_id, :integration_config_id, :local_type, :local_id, :external_id, :external_type, :metadata, :last_synced_at, :created_at, :updated_at",
        "API routes: GET /api/v1/integration_configs/:integration_config_id/sync_mappings (index), GET /api/v1/sync_mappings/:id (show), DELETE /api/v1/sync_mappings/:id (destroy)",
        "Controller: Api::V1::SyncMappingsController; index supports optional local_type filter param; mappings are created/updated by sync jobs, not manually via API (no create/update endpoints)",
        "Factory :sync_mapping with association :tenant, :integration_config, local_type 'Course', local_id 1, external_id '123456', external_type 'classroom_course', metadata {}",
        "Request specs: list mappings as admin (200), list as teacher (200), list as student (403), show, delete, filter by local_type, Rubocop passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Tech Spec 2.4: SyncMapping is the bidirectional ID map between LMS entities and Google Classroom entities. Two unique indexes ensure one-to-one mapping in both directions. Sync jobs create/update these; the API is read/delete only."
    },
    {
      "id": "US-070",
      "title": "SyncRun and SyncLog models with tracking API",
      "description": "As an admin, I need to track sync job executions and review detailed logs so I can monitor integration health and troubleshoot failures.",
      "acceptanceCriteria": [
        "SyncRun model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), integration_config_id (FK → integration_configs, NOT NULL, indexed), sync_type (string, NOT NULL), direction (string, NOT NULL, default 'push'), status (string, NOT NULL, default 'pending'), started_at (datetime), completed_at (datetime), records_processed (integer, NOT NULL, default 0), records_succeeded (integer, NOT NULL, default 0), records_failed (integer, NOT NULL, default 0), error_message (text), triggered_by_id (FK → users, optional), timestamps",
        "VALID_SYNC_TYPES = %w[course_sync roster_sync coursework_push grade_passback].freeze",
        "VALID_DIRECTIONS = %w[push pull bidirectional].freeze",
        "VALID_STATUSES = %w[pending running completed failed].freeze",
        "SyncLog model: id (bigint PK), tenant_id (FK → tenants, NOT NULL, indexed), sync_run_id (FK → sync_runs, NOT NULL, indexed), level (string, NOT NULL, default 'info'), message (text, NOT NULL), entity_type (string), entity_id (bigint), external_id (string), metadata (jsonb, NOT NULL, default {}), timestamps",
        "VALID_LEVELS = %w[info warn error].freeze",
        "Migration 1: create_sync_runs with all columns, indexes on tenant_id and integration_config_id",
        "Migration 2: create_sync_logs with all columns, index on sync_run_id and tenant_id",
        "Both include TenantScoped concern",
        "SyncRun: belongs_to :integration_config, belongs_to :triggered_by (class_name: 'User', optional: true), has_many :sync_logs (dependent: :destroy)",
        "SyncLog: belongs_to :sync_run",
        "SyncRun validates: sync_type inclusion, direction inclusion, status inclusion",
        "SyncLog validates: level inclusion, message presence",
        "SyncRun#start! sets started_at = Time.current, status = 'running'; SyncRun#complete! sets completed_at = Time.current, status = 'completed'; SyncRun#fail!(message) sets completed_at, status = 'failed', error_message",
        "SyncRun#log_info(message, **opts), log_warn(message, **opts), log_error(message, **opts) convenience methods that create SyncLog records with entity_type, entity_id, external_id, metadata from opts",
        "Pundit SyncRunPolicy: index? returns user.has_role?(:admin) || user.has_role?(:teacher); show? same; Scope: admin sees all, teacher sees runs for configs they can see",
        "Pundit SyncLogPolicy: index? same as SyncRunPolicy",
        "SyncRunSerializer: attributes :id, :tenant_id, :integration_config_id, :sync_type, :direction, :status, :started_at, :completed_at, :records_processed, :records_succeeded, :records_failed, :error_message, :triggered_by_id, :created_at, :updated_at",
        "SyncLogSerializer: attributes :id, :sync_run_id, :level, :message, :entity_type, :entity_id, :external_id, :metadata, :created_at",
        "API routes: GET /api/v1/integration_configs/:integration_config_id/sync_runs (index), GET /api/v1/sync_runs/:id (show), GET /api/v1/sync_runs/:id/sync_logs (nested index)",
        "Controller: Api::V1::SyncRunsController; index supports status filter and sync_type filter; ordered by created_at DESC",
        "Controller: Api::V1::SyncLogsController; index supports level filter; ordered by created_at ASC",
        "Factory :sync_run with association :tenant, :integration_config, sync_type 'course_sync', direction 'pull', status 'pending'",
        "Factory :sync_log with association :tenant, :sync_run, level 'info', message 'Test log entry'",
        "Request specs: list sync runs, show run with logs, filter by status, filter by sync_type, filter logs by level, start/complete/fail lifecycle, admin access (200), student access (403), Rubocop passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Tech Spec 2.4, 2.7: SyncRun and SyncLog provide full observability into integration syncs. The log_info/warn/error convenience methods make it easy for sync jobs to record progress. Runs are created and managed by jobs, read-only via API."
    },
    {
      "id": "US-071",
      "title": "Google Classroom API service layer",
      "description": "As a developer, I need a service layer wrapping the Google Classroom API so sync jobs can interact with Google Classroom using a clean interface.",
      "acceptanceCriteria": [
        "Add gems to Gemfile: gem 'google-apis-classroom_v1'; gem 'google-apis-drive_v3'",
        "Bundle install and verify gems load correctly",
        "GoogleClassroomService class in app/services/google_classroom_service.rb: initialize(user) — creates Google::Apis::ClassroomV1::ClassroomService and authorizes with GoogleTokenService.new(user).credentials",
        "list_courses — calls service.list_courses(teacher_id: 'me', course_states: ['ACTIVE']), returns array of course objects",
        "get_course(course_id) — calls service.get_course(course_id), returns course object",
        "list_students(course_id) — calls service.list_students(course_id), handles pagination, returns array of student objects",
        "create_coursework(course_id, attrs) — calls service.create_course_work(course_id, coursework_object) where attrs include title, description, max_points, due_date, work_type",
        "update_coursework(course_id, coursework_id, attrs) — calls service.patch_course_work(course_id, coursework_id, coursework_object, update_mask: fields)",
        "list_student_submissions(course_id, coursework_id) — returns submissions from Classroom",
        "update_student_submission_grade(course_id, coursework_id, submission_id, grade) — patches assigned_grade and draft_grade on the Classroom submission",
        "All methods rescue Google::Apis::Error and re-raise as custom GoogleApiError < StandardError with message and status_code attributes",
        "GoogleApiError class defined in app/errors/google_api_error.rb",
        "GoogleDriveService class in app/services/google_drive_service.rb: initialize(user) — creates Google::Apis::DriveV3::DriveService authorized with user's credentials",
        "GoogleDriveService#create_document(title, mime_type: 'application/vnd.google-apps.document') — creates an empty Google Doc, returns { id, title, url, mime_type }",
        "GoogleDriveService#create_presentation(title) — creates an empty Google Slides presentation, returns { id, title, url, mime_type }",
        "GoogleDriveService#get_file(file_id) — returns file metadata { id, name, mimeType, webViewLink }",
        "Service specs: GoogleClassroomService methods with stubbed Google API (WebMock or instance_double on the Google service); test list_courses returns mapped data, create_coursework builds correct request, error handling wraps Google::Apis::Error",
        "Service specs: GoogleDriveService methods with stubbed Google API; test create_document, create_presentation, get_file",
        "Rubocop passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "PRD-13, PRD-20: The service layer is the clean abstraction over Google's API gems. All sync jobs and controllers use these services instead of calling Google APIs directly. Error wrapping with GoogleApiError provides consistent error handling. Stubbed specs allow testing without Google credentials."
    },
    {
      "id": "US-072",
      "title": "ClassroomCourseSyncJob — sync courses from Google Classroom",
      "description": "As an admin, I need to pull courses from Google Classroom and create mappings to LMS courses so teachers can link their Classroom courses.",
      "acceptanceCriteria": [
        "ClassroomCourseSyncJob (Sidekiq) in app/jobs/classroom_course_sync_job.rb: accepts integration_config_id and user_id (the user whose tokens to use for API calls)",
        "Job pattern: uses IntegrationConfig.unscoped.find and sets Current.tenant from the record's tenant_id (same pattern as PdfExportJob)",
        "Creates a SyncRun (sync_type: 'course_sync', direction: 'pull') and calls start!",
        "Uses GoogleClassroomService.new(user) to list_courses from Google Classroom",
        "For each Classroom course: checks if SyncMapping exists for external_type 'classroom_course' and external_id; if not, creates a new local Course (name: classroom_course.name, code: classroom_course.id, academic_year: tenant's current AcademicYear) and creates SyncMapping; if exists, updates the existing Course name if changed",
        "Logs each action via sync_run.log_info/log_warn/log_error with entity_type, entity_id, external_id",
        "Updates sync_run counters: records_processed, records_succeeded, records_failed",
        "On success: sync_run.complete!; on any unhandled error: sync_run.fail!(error.message)",
        "Updates SyncMapping#last_synced_at on each successful sync",
        "API endpoint: POST /api/v1/integration_configs/:id/sync_courses — triggers job, returns 202 with sync_run_id; admin/teacher only",
        "Pundit: trigger_sync? on IntegrationConfigPolicy requires admin or teacher role",
        "Job spec: stub GoogleClassroomService, verify courses created, sync_mappings created, sync_run completed with correct counts",
        "Request spec: trigger sync (202), admin access, student access (403), Rubocop passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "PRD-13: Course sync is the first step in Classroom integration. Pulling courses creates the local mirror that subsequent syncs (roster, coursework) build on. Uses the idempotent job pattern established in M1/M4."
    },
    {
      "id": "US-073",
      "title": "ClassroomRosterSyncJob — sync student enrollments from Google Classroom",
      "description": "As a teacher, I need student rosters pulled from Google Classroom so my LMS sections reflect actual Classroom enrollment.",
      "acceptanceCriteria": [
        "ClassroomRosterSyncJob (Sidekiq) in app/jobs/classroom_roster_sync_job.rb: accepts integration_config_id, user_id, and course_sync_mapping_id (the SyncMapping for the course to sync)",
        "Job pattern: same as ClassroomCourseSyncJob (unscoped find, set Current.tenant, create SyncRun with sync_type: 'roster_sync', direction: 'pull')",
        "Uses GoogleClassroomService.new(user).list_students(classroom_course_id) to get student list",
        "For each Classroom student: find or create User by email (google_classroom_profile.emailAddress) within the tenant; find or create Section for the course (use default section or first section); find or create Enrollment (user, section, role: 'student')",
        "Creates SyncMapping for each enrollment: local_type 'Enrollment', external_type 'classroom_student', external_id = student.userId",
        "Skips students whose email domain doesn't match the integration_config settings domain (if domain is set); logs warning",
        "Updates sync_run counters and logs for each student processed",
        "API endpoint: POST /api/v1/sync_mappings/:id/sync_roster — triggers job for a course mapping, returns 202; teacher/admin only",
        "Job spec: stub GoogleClassroomService, verify users created/found, enrollments created, sync_mappings created, domain filtering works",
        "Request spec: trigger roster sync (202), verify only for course-type mappings, Rubocop passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "PRD-13: Roster sync keeps LMS enrollment in sync with Classroom. Domain filtering prevents enrolling students from other tenants. User find-or-create uses email as the unique key within tenant."
    },
    {
      "id": "US-074",
      "title": "ClassroomCourseworkPushJob — push assignments to Google Classroom",
      "description": "As a teacher, I need to push LMS assignments to Google Classroom as coursework so students see assignments in both systems.",
      "acceptanceCriteria": [
        "ClassroomCourseworkPushJob (Sidekiq) in app/jobs/classroom_coursework_push_job.rb: accepts integration_config_id, user_id, and assignment_id",
        "Job pattern: same as other sync jobs (unscoped find, set Current.tenant, create SyncRun with sync_type: 'coursework_push', direction: 'push')",
        "Finds the course SyncMapping for the assignment's course; raises and fails sync_run if no course mapping exists",
        "Uses GoogleClassroomService.new(user).create_coursework(classroom_course_id, { title: assignment.title, description: assignment.description, max_points: assignment.max_points, due_date: assignment.due_at, work_type: 'ASSIGNMENT' })",
        "If SyncMapping already exists for this assignment (local_type 'Assignment', external_type 'classroom_coursework'), calls update_coursework instead of create_coursework",
        "Creates/updates SyncMapping for the assignment with the returned coursework.id as external_id",
        "Logs success/failure, updates sync_run counters",
        "API endpoint: POST /api/v1/assignments/:id/push_to_classroom — triggers job, returns 202; teacher/admin only; validates assignment is published before pushing",
        "AssignmentPolicy#push_to_classroom? returns user.has_role?(:admin) || user.has_role?(:teacher)",
        "Add route as member action on assignments resource",
        "Job spec: stub GoogleClassroomService, verify coursework created with correct attributes, sync_mapping created, update case when mapping already exists",
        "Request spec: push published assignment (202), push draft assignment (422), push without course mapping (422), student access (403), Rubocop passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "PRD-13, PRD-20: Coursework push is the 'assign via Classroom' step in the Google-Native workflow. Idempotent — pushing the same assignment again updates rather than duplicates."
    },
    {
      "id": "US-075",
      "title": "ClassroomGradePassbackJob — push grades to Google Classroom",
      "description": "As a teacher, I need grades synced back to Google Classroom so students and parents see updated grades in Classroom.",
      "acceptanceCriteria": [
        "ClassroomGradePassbackJob (Sidekiq) in app/jobs/classroom_grade_passback_job.rb: accepts integration_config_id, user_id, and assignment_id",
        "Job pattern: same as other sync jobs",
        "Finds assignment SyncMapping (classroom_coursework) and course SyncMapping (classroom_course); fails if either missing",
        "Loads all returned/graded submissions for the assignment: assignment.submissions.where(status: ['graded', 'returned'])",
        "For each submission: finds enrollment SyncMapping for the student (local_type 'Enrollment'); if no student mapping, skips with warning; calls GoogleClassroomService.new(user).update_student_submission_grade(classroom_course_id, coursework_id, student_classroom_id, submission.grade)",
        "Creates/updates SyncMapping for each submission (local_type 'Submission', external_type 'classroom_submission', external_id = classroom_submission_id)",
        "Logs each grade passback, updates sync_run counters",
        "API endpoint: POST /api/v1/assignments/:id/sync_grades — triggers job, returns 202; teacher/admin only; validates assignment has coursework SyncMapping",
        "AssignmentPolicy#sync_grades? returns user.has_role?(:admin) || user.has_role?(:teacher)",
        "Add route as member action on assignments resource",
        "Job spec: stub GoogleClassroomService, verify grades pushed for each graded submission, skips students without mapping, sync_run completed with counts",
        "Request spec: sync grades (202), sync without coursework mapping (422), student access (403), Rubocop passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "PRD-13: Grade passback completes the bidirectional sync loop. Teachers grade in the LMS, grades flow to Classroom automatically. Only syncs graded/returned submissions to avoid premature grade visibility."
    },
    {
      "id": "US-076",
      "title": "Google Drive service — create Docs/Slides and resource link endpoints",
      "description": "As a teacher, I need to create Google Docs and Slides directly from the LMS and attach them as resource links to lessons and units.",
      "acceptanceCriteria": [
        "POST /api/v1/drive/documents — creates a Google Doc via GoogleDriveService.new(Current.user).create_document(params[:title]); returns { id, title, url, mime_type } as JSON; creates a ResourceLink with provider 'google_drive', drive_file_id, url, title, mime_type attached to the specified linkable (params[:linkable_type], params[:linkable_id])",
        "POST /api/v1/drive/presentations — creates a Google Slides presentation via GoogleDriveService; same response and ResourceLink creation pattern",
        "GET /api/v1/drive/files/:file_id — proxy to GoogleDriveService.get_file(file_id); returns file metadata { id, name, mime_type, url }",
        "POST /api/v1/drive/picker_token — returns the user's current valid Google access token (via GoogleTokenService) for use with the Google Picker API on the frontend; returns { access_token, expires_in }",
        "Controller: Api::V1::DriveController; all actions require authenticated user with google_connected? == true; return 422 'Google account not connected' otherwise",
        "Pundit DrivePolicy: create_document? returns true (any authenticated user); create_presentation? same; picker_token? same; show_file? same",
        "Validate linkable_type is in allowed list: %w[LessonVersion UnitVersion CourseModule Assignment]",
        "Request specs: create document (201), create presentation (201), get file metadata (200), picker token (200), not connected (422), invalid linkable_type (422), student can create (201), Rubocop passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "PRD-20: 'create Docs/Slides' is part of the Google-Native workflow. Creating a Doc/Slides immediately attaches it as a resource link. The picker_token endpoint enables the frontend Google Picker widget for browsing existing Drive files."
    },
    {
      "id": "US-077",
      "title": "Next.js Admin Integrations configuration page",
      "description": "As an admin, I need a web interface to configure Google Classroom integration settings and manage the connection status.",
      "acceptanceCriteria": [
        "Update AppShell NAV_ITEMS: change Admin from { label: 'Admin', href: '/admin' } to { label: 'Admin', href: '/admin', children: [{ label: 'Curriculum Map', href: '/admin/curriculum-map' }, { label: 'Approvals', href: '/admin/approvals' }, { label: 'Integrations', href: '/admin/integrations' }] }",
        "Integrations page at /admin/integrations: 'use client', ProtectedRoute + AppShell wrapper",
        "Fetches GET /api/v1/integration_configs; if no config exists, shows 'Set Up Google Classroom' card with setup form",
        "Setup form: domain (text input), classroom_enabled (checkbox), drive_enabled (checkbox), auto_sync_enabled (checkbox), sync_interval_hours (number input, default 24); save calls POST /api/v1/integration_configs with provider: 'google_classroom' and settings object",
        "When config exists: shows status badge (active/inactive/error), settings summary (domain, features enabled, sync interval), last sync timestamp",
        "Edit settings: inline editable fields, save calls PATCH /api/v1/integration_configs/:id",
        "Activate/Deactivate toggle: calls POST /activate or /deactivate",
        "Connection status section: shows whether the current admin user has google_connected == true; if not, shows 'Connect Google Account' link to /auth/google_oauth2",
        "Manual sync trigger: 'Sync Courses Now' button calls POST /api/v1/integration_configs/:id/sync_courses; shows 'Sync triggered' confirmation",
        "Role guard: page only accessible to admin users (check roles from auth context)",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 11,
      "passes": true,
      "notes": "UX 3.6, PRD-13: Admin Integrations is the control center for Google Classroom connectivity. One-time setup flow transitions to management view once configured. Manual sync trigger allows admin to initiate syncs on demand."
    },
    {
      "id": "US-078",
      "title": "Next.js Sync Dashboard page",
      "description": "As an admin, I need to view sync run history and detailed logs so I can monitor integration health and troubleshoot issues.",
      "acceptanceCriteria": [
        "Sync Dashboard page at /admin/integrations/sync: 'use client', ProtectedRoute + AppShell wrapper, admin only",
        "Fetches integration_config for current tenant, then GET /api/v1/integration_configs/:id/sync_runs",
        "Sync Runs table: sync_type (badge), direction (push/pull icon), status (color-coded badge: pending=gray, running=blue, completed=green, failed=red), started_at (formatted), completed_at, records_processed, records_succeeded, records_failed, triggered_by",
        "Filter by: sync_type dropdown (all, course_sync, roster_sync, coursework_push, grade_passback), status dropdown (all, pending, running, completed, failed)",
        "Click a sync run row to expand and show sync logs: fetches GET /api/v1/sync_runs/:id/sync_logs",
        "Sync Logs list within expanded run: level icon (info=blue, warn=yellow, error=red), timestamp, message, entity_type, entity_id, external_id",
        "Filter logs by level (all, info, warn, error)",
        "Summary stats at top: total runs (last 30 days), success rate (%), last successful sync timestamp, last failed sync timestamp",
        "Sync Mappings tab: fetches GET /api/v1/integration_configs/:id/sync_mappings, shows table with local_type, local_id, external_type, external_id, last_synced_at; filter by local_type; delete button (with confirm) calls DELETE /api/v1/sync_mappings/:id",
        "Link from /admin/integrations page: 'View Sync History' link to this page",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Tech Spec 2.4, UX 3.6: The Sync Dashboard gives admins full visibility into integration operations. Expandable run rows with inline logs avoid extra navigation. Mapping management allows cleanup of stale or incorrect mappings."
    },
    {
      "id": "US-079",
      "title": "Next.js Teacher Classroom Sync UI",
      "description": "As a teacher, I need to link my LMS courses to Google Classroom and push assignments so content stays synchronized across both platforms.",
      "acceptanceCriteria": [
        "Course Home page (/teach/courses/[courseId]): add 'Google Classroom' section (collapsible, only shown when integration_config is active and user has google_connected)",
        "Google Classroom section fetches sync_mappings for the current course (GET /api/v1/integration_configs/:configId/sync_mappings?local_type=Course)",
        "If course is not linked: show 'Link to Google Classroom' button that triggers POST /api/v1/integration_configs/:id/sync_courses to pull courses, then shows a dropdown of synced Classroom courses to select; on select, creates/uses the SyncMapping",
        "If course is linked: show Classroom course name (from metadata), last synced timestamp, and action buttons",
        "Action buttons: 'Sync Roster' calls POST /api/v1/sync_mappings/:id/sync_roster (returns 202); 'Sync All Assignments' iterates published assignments and pushes each",
        "Assignment Editor page (/teach/courses/[courseId]/assignments/[assignmentId]): add 'Push to Google Classroom' button (only visible when course has Classroom mapping and assignment is published)",
        "Push button: calls POST /api/v1/assignments/:id/push_to_classroom, shows spinner, then success message with Classroom link",
        "If assignment already pushed (has SyncMapping): button text changes to 'Update in Classroom', re-push updates existing coursework",
        "'Sync Grades' button: visible when assignment has submissions and is pushed to Classroom; calls POST /api/v1/assignments/:id/sync_grades",
        "Sync status indicators: small badge on each assignment card in course home showing 'Synced' (green) or 'Not synced' (gray) based on SyncMapping existence",
        "Fetch integration_config once at course page level and pass to child components",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 13,
      "passes": true,
      "notes": "PRD-13, PRD-20, UX 3.8: The teacher-facing Classroom sync UI is the main workflow integration point. Teachers link courses once, then push/update assignments as they work. Grade passback closes the loop."
    },
    {
      "id": "US-080",
      "title": "Next.js Google Drive Picker and document creation integration",
      "description": "As a teacher, I need to browse my Google Drive files and create new Docs/Slides directly from the LMS so I can attach Drive content to lessons and assignments.",
      "acceptanceCriteria": [
        "Google Drive Picker component at src/components/GoogleDrivePicker.tsx: 'use client', loads Google Picker API script (https://apis.google.com/js/api.js) dynamically",
        "On mount: fetches picker token from GET /api/v1/drive/picker_token to get the user's access_token",
        "Picker opens as modal overlay when triggered; user browses Drive files; on select, returns file { id, name, mimeType, url }",
        "Used in Lesson Editor (/plan/units/[id]/lessons/[lessonId]): add 'Attach from Drive' button next to existing URL resource link form; clicking opens picker; on file select, creates ResourceLink via POST /api/v1/resource_links with provider 'google_drive', drive_file_id, url, title, mime_type",
        "Used in Assignment Editor (/teach/courses/[courseId]/assignments/[assignmentId]): add 'Attach from Drive' button; same picker flow",
        "Create Document buttons: 'New Google Doc' and 'New Google Slides' buttons on Lesson Editor and Assignment Editor",
        "'New Google Doc' calls POST /api/v1/drive/documents with title = lesson/assignment title, linkable_type and linkable_id; shows created document link and opens in new tab",
        "'New Google Slides' calls POST /api/v1/drive/presentations with same pattern",
        "Show attached Drive files with Google icon, file name as link (opens in new tab), mime type badge, and detach button",
        "Hide Drive-related buttons when user does not have google_connected (check from auth context /api/v1/me response)",
        "Google Picker API client ID sourced from NEXT_PUBLIC_GOOGLE_CLIENT_ID env var",
        "npm run lint passes",
        "npm run build succeeds"
      ],
      "priority": 14,
      "passes": true,
      "notes": "PRD-20: 'Attach Drive → create Docs/Slides' is the core Google-Native workflow. The Drive Picker provides a native file browsing experience. Creating Docs/Slides in-place eliminates context switching. The Drive attach < 30 seconds success metric (PRD-8) requires a fast, streamlined flow."
    },
    {
      "id": "US-081",
      "title": "Workspace Add-on API endpoints for Docs/Slides sidebar",
      "description": "As a teacher using Google Docs or Slides, I need API endpoints that a Workspace Add-on sidebar can call to browse LMS content and attach the current document to a lesson or unit.",
      "acceptanceCriteria": [
        "GET /api/v1/addon/unit_plans — returns user's unit plans (id, title, status, course_name) ordered by updated_at DESC; lightweight response for add-on sidebar display; uses policy_scope",
        "GET /api/v1/addon/unit_plans/:id/lessons — returns lessons for a unit plan (id, title, position) from the current version",
        "POST /api/v1/addon/attach — accepts { drive_file_id, drive_file_url, drive_file_title, drive_mime_type, linkable_type, linkable_id }; creates a ResourceLink with provider 'google_drive'; returns the created resource link",
        "GET /api/v1/addon/me — returns minimal user info (id, name, email, tenant_name) for display in the add-on sidebar",
        "Controller: Api::V1::AddonController; authenticate_user! applies (session-based or token-based auth); all actions require teacher or admin role",
        "Pundit AddonPolicy: all actions require user.has_role?(:teacher) || user.has_role?(:admin)",
        "CORS: add /api/v1/addon/* to CORS allowed origins for *.google.com (for Workspace Add-on cross-origin calls); update config/initializers/cors.rb with additional origin pattern",
        "Rate limiting: add Rack::Attack throttle rule for /api/v1/addon/* endpoints at 60 requests per minute per user (prevent abuse from external context)",
        "Add rack-attack gem to Gemfile if not present",
        "Create packages/google-addon/README.md documenting the Add-on API endpoints, authentication flow, and instructions for deploying a Google Workspace Add-on that calls these endpoints",
        "Request specs: addon/unit_plans returns user's plans, addon/lessons returns lessons, addon/attach creates resource link, addon/me returns user info, student access (403), Rubocop passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "UX 3.8, PRD-13: These API endpoints form the backend contract for a Google Workspace Add-on sidebar. The add-on itself (Apps Script or GWS framework) is deployed separately and calls these endpoints. Providing the API surface and documentation enables future add-on development."
    }
  ]
}
