# Ralph Progress Log — K-12 Planning + LMS Platform
# This file is append-only. Each iteration adds learnings below.

## Project Context
- Monorepo: apps/web (Next.js), apps/core (Rails API-only), apps/ai-gateway (FastAPI)
- Multi-tenant: every table has tenant_id
- Auth: OmniAuth Google OIDC + SAML
- API: JSON REST under /api/v1
- See docs/ for full PRD, Tech Spec, and UX Spec

## Codebase Patterns
- Ruby 4.0.1 via Homebrew at /opt/homebrew/opt/ruby/bin
- PostgreSQL 16 via Homebrew, service: `brew services start postgresql@16`
- PATH must include: /opt/homebrew/opt/ruby/bin:/opt/homebrew/lib/ruby/gems/4.0.0/bin:/opt/homebrew/opt/postgresql@16/bin
- All rails/bundle commands must be run from apps/core with above PATH set
- Rails 8.1.2 API-only, RSpec 8.0.2, rubocop-rails-omakase for linting
- RSpec configured with FactoryBot, shoulda-matchers, database_cleaner
- spec/support/ directory auto-loaded via glob in rails_helper.rb
- CORS configured in config/initializers/cors.rb with CORS_ORIGINS env var

## Iteration Log
### Iteration 1 — US-001: Initialize Rails API app
- Created Rails 8.1.2 API-only app in apps/core
- Installed gems: pg, devise, omniauth, omniauth-google-oauth2, pundit, sidekiq, active_model_serializers, rack-cors, rubocop-rails-omakase, rspec-rails, factory_bot_rails, faker, shoulda-matchers
- Configured RSpec, CORS, PostgreSQL databases
- Trivial test passing, rubocop clean

### Iteration 2 — US-002: Initialize Next.js frontend app
- Next.js 16.1.6 with TypeScript strict mode, App Router
- Tailwind CSS v4 via @tailwindcss/postcss plugin
- ESLint: eslint-config-next (core-web-vitals + typescript) + eslint-config-prettier
- Prettier: semi, double quotes, trailing commas, 2-space tabs, 100 print width
- AppShell component with left nav (Plan, Teach, Assess, Report, Communicate, Admin) per UX §3.2
- All quality checks pass: lint, typecheck, build
- Path alias: @/* maps to ./src/*
- Frontend commands run from apps/web directory

### Iteration 3 — US-003: Tenant and School models with multi-tenancy
- Created Current class (ActiveSupport::CurrentAttributes) with :tenant and :user attributes
- Created TenantScoped concern in app/models/concerns/tenant_scoped.rb
- TenantScoped includes: default_scope with Current.tenant, before_validation callback, validations
- Tenant model: name, slug (unique, lowercase-hyphenated), settings (jsonb defaults to {})
- School model: includes TenantScoped, belongs_to :tenant, validates name and timezone
- Migrations: tenant slug has unique index, schools.tenant_id has NOT NULL + index + FK
- Factories use sequences for name/slug to avoid uniqueness conflicts
- Specs verify tenant scoping: queries auto-filtered by Current.tenant, auto-assignment on create
- Pattern: Tenant is NOT tenant-scoped (top-level entity), all other models should include TenantScoped
- Quality checks: 17 examples passing, rubocop clean, migrations successful

### Iteration 4 — US-004: User model, Roles, and RBAC with Pundit
- User model: id, tenant_id, email, first_name, last_name (TenantScoped)
- Role model: id, tenant_id, name (enum: admin, curriculum_lead, teacher, student, guardian)
- UserRole join model: user_id, role_id, tenant_id with unique constraint on [user_id, role_id]
- User#has_role?(role_name) checks role membership
- User#add_role(role_name) idempotently creates/finds role and assigns
- ApplicationPolicy base class with default deny-all, Scope pattern
- UserPolicy: admin can CRUD all users, users can view/update self, curriculum_lead can index
- Pundit RSpec support: added `require "pundit/rspec"` to rails_helper.rb for `permissions` matcher
- Tenant model updated with `has_many :users` and `has_many :roles`
- Gotcha: `build(:role)` without explicit tenant results in nil tenant_id — always pass tenant in tests
- Quality checks: 67 examples passing, rubocop clean, migrations successful

### Iteration 5 — US-005: OmniAuth Google OIDC authentication
- Added session/cookie middleware back to API-only app in config/application.rb
- OmniAuth initializer: config/initializers/omniauth.rb with Google OAuth2 strategy
- Api::V1::SessionsController handles: omniauth_callback, failure, destroy (sign-out), me (current user)
- ApplicationController: authenticate_user! before_action, sets Current.tenant and Current.user from session
- Routes: /auth/:provider/callback, /auth/failure, /api/v1/session (DELETE), /api/v1/me (GET)
- Tenant resolution: matches email domain slug to tenant slug, falls back to first tenant
- spec/support/authentication_helpers.rb: sign_in_as and mock_session helpers for request specs
- Gotcha: use `let!(:tenant)` (eager) in request specs where tenant must exist before the callback
- Quality checks: 74 examples passing, rubocop clean

### Iteration 6 — US-006: API authentication middleware and tenant resolution
- ApplicationController enhanced: Pundit::Authorization included, authenticate_user! before_action
- Tenant resolution chain: session → X-Tenant-Slug header → subdomain
- User resolved from session user_id + current tenant (cross-tenant access blocked)
- Pundit enforcement: verify_authorized/verify_policy_scoped after_actions with skip_authorization? override
- SessionsController overrides skip_authorization? to skip Pundit checks on auth endpoints
- Gotcha: Rails 7.1+ raises AbstractController::ActionNotFound if after_action uses only:/except: referencing actions not on the controller. Use lambda conditions instead: `unless: -> { skip_authorization? || action_name == "index" }`
- config/environments/test.rb: `config.hosts = nil` to disable host authorization in tests
- Request specs: unauthenticated → 401, wrong tenant → 401 (user not found in other tenant), header-based tenant resolution
- Quality checks: 79 examples passing, rubocop clean

### Iteration 7 — US-007: AcademicYear and Term models
- AcademicYear: name, start_date, end_date, current (boolean), tenant_id — TenantScoped, has_many :terms
- Term: name, start_date, end_date, academic_year_id, tenant_id — TenantScoped, belongs_to :academic_year
- Both validate end_date > start_date with custom validator
- Policies: all authenticated users can read; admin/curriculum_lead can create/update; admin can destroy
- CRUD controllers: Api::V1::AcademicYearsController, Api::V1::TermsController
- Terms index supports filtering by academic_year_id param
- AMS adapter is :attributes (no root key wrapping) — index returns array, show returns flat object
- Added current_user and pundit_user methods to ApplicationController (required by Pundit)
- Use :unprocessable_content instead of :unprocessable_entity (Rack deprecation in Rails 8.1)
- Quality checks: 112 examples passing, rubocop clean

### Iteration 8 — US-008: Course, Section, and Enrollment models
- Course: name, code, description, academic_year_id, tenant_id — has_many :sections
- Section: name, course_id, term_id, tenant_id — has_many :enrollments, has_many :users through enrollments
- Enrollment: user_id, section_id, role (enum: teacher/student), tenant_id — unique on [user_id, section_id]
- All three include TenantScoped with CRUD API endpoints
- Enrollment enforces one role per user per section via uniqueness constraint
- Quality checks: 139 examples passing, rubocop clean

### Iteration 9 — US-009: StandardFramework and Standard models
- StandardFramework: name, jurisdiction, subject, version, tenant_id — has_many :standards
- Standard: code, description, grade_band, standard_framework_id, parent_id (self-ref), tenant_id
- Self-referential tree: parent/children associations via parent_id FK to standards table
- Standard#tree recursively builds nested hash for API tree endpoint
- Standard.roots scope returns standards with nil parent_id
- Tree endpoint: GET /api/v1/standard_frameworks/:id/tree — member route on standard_frameworks resource
- Gotcha: member route passes params[:id] not params[:standard_framework_id]
- Quality checks: 158 examples passing, rubocop clean
