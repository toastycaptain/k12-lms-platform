#!/bin/sh
set -eu

npx lint-staged

# Ensure Python tooling (ruff) is available
PYTHON_BIN="$(python3 -c 'import sysconfig; print(sysconfig.get_path("scripts"))' 2>/dev/null || true)"
if [ -n "$PYTHON_BIN" ] && [ -d "$PYTHON_BIN" ]; then
  export PATH="$PYTHON_BIN:$PATH"
fi

# Ensure rbenv is available so we use the project Ruby, not system Ruby
if [ -d "$HOME/.rbenv/bin" ]; then
  export PATH="$HOME/.rbenv/bin:$PATH"
fi
if command -v rbenv >/dev/null 2>&1; then
  eval "$(rbenv init - sh)"
fi

ruby_files="$(git diff --cached --name-only --diff-filter=ACM -- 'apps/core/**/*.rb')"
if [ -n "$ruby_files" ]; then
  core_files="$(printf '%s\n' "$ruby_files" | sed 's#^apps/core/##')"
  (
    cd apps/core
    printf '%s\n' "$core_files" | xargs bundle exec rubocop --autocorrect-all --force-exclusion
  )
  printf '%s\n' "$ruby_files" | xargs git add
fi

python_files="$(git diff --cached --name-only --diff-filter=ACM -- 'apps/ai-gateway/**/*.py')"
if [ -n "$python_files" ]; then
  gateway_files="$(printf '%s\n' "$python_files" | sed 's#^apps/ai-gateway/##')"
  (
    cd apps/ai-gateway
    printf '%s\n' "$gateway_files" | xargs ruff check --fix
  )
  printf '%s\n' "$python_files" | xargs git add
fi
