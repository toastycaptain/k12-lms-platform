openapi: 3.0.3
info:
  title: K-12 LMS Core API
  version: 1.1.0
  description: |
    Contract for high-priority Core API v1 endpoints consumed by the web app.
    This document intentionally focuses on the 20 highest-traffic endpoints.
  license:
    name: Proprietary
    url: https://github.com/toastycaptain/k12-lms-platform
servers:
  - url: https://api.k12-lms.platform
security:
  - cookieAuth: []
paths:
  /api/v1/me:
    get:
      summary: Current authenticated user and tenant
      operationId: getMe
      tags: [Auth]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Current user context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/session:
    delete:
      summary: Sign out current session
      operationId: deleteSession
      tags: [Auth]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Session ended
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionDestroyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/courses:
    get:
      summary: List courses
      operationId: listCourses
      tags: [Courses]
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Courses visible to current user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Course"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Create course
      operationId: createCourse
      tags: [Courses]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [course]
              properties:
                course:
                  $ref: "#/components/schemas/CourseCreateInput"
      responses:
        "201":
          description: Course created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Course"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationErrors"

  /api/v1/courses/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: Show course
      operationId: showCourse
      tags: [Courses]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Course detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Course"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update course
      operationId: updateCourse
      tags: [Courses]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [course]
              properties:
                course:
                  $ref: "#/components/schemas/CourseUpdateInput"
      responses:
        "200":
          description: Updated course
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Course"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationErrors"

  /api/v1/courses/{course_id}/assignments:
    parameters:
      - in: path
        name: course_id
        required: true
        schema:
          type: integer
    get:
      summary: List assignments for a course
      operationId: listCourseAssignments
      tags: [Assignments]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Assignment list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Assignment"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    post:
      summary: Create assignment for a course
      operationId: createCourseAssignment
      tags: [Assignments]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignmentCreateInput"
      responses:
        "201":
          description: Assignment created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Assignment"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationErrors"

  /api/v1/assignments/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: Show assignment
      operationId: showAssignment
      tags: [Assignments]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Assignment detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Assignment"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/assignments/{id}/submissions:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: List submissions for an assignment
      operationId: listAssignmentSubmissions
      tags: [Submissions]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Submission list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Submission"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    post:
      summary: Create assignment submission
      operationId: createAssignmentSubmission
      tags: [Submissions]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmissionCreateInput"
      responses:
        "201":
          description: Submission created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Submission"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationErrors"

  /api/v1/unit_plans:
    get:
      summary: List unit plans
      operationId: listUnitPlans
      tags: [UnitPlans]
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: course_id
          schema:
            type: integer
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Unit plans visible to current user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UnitPlan"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/unit_plans/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: Show unit plan
      operationId: showUnitPlan
      tags: [UnitPlans]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Unit plan detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitPlan"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/notifications:
    get:
      summary: List notifications
      operationId: listNotifications
      tags: [Notifications]
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: unread_only
          schema:
            type: boolean
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Notification list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Notification"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/notifications/unread_count:
    get:
      summary: Get unread notification count
      operationId: getNotificationUnreadCount
      tags: [Notifications]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Unread count
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnreadCountResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/notifications/mark_all_read:
    post:
      summary: Mark all notifications read
      operationId: markAllNotificationsRead
      tags: [Notifications]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Updated notification count
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarkAllReadResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/message_threads:
    get:
      summary: List message threads
      operationId: listMessageThreads
      tags: [Messaging]
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Message thread list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MessageThread"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/quizzes/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: Show quiz
      operationId: showQuiz
      tags: [Quizzes]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Quiz detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Quiz"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/courses/{id}/gradebook:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: integer
    get:
      summary: Course gradebook snapshot
      operationId: showCourseGradebook
      tags: [Gradebook]
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Gradebook rows
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GradebookRow"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/search:
    get:
      summary: Global search
      operationId: searchGlobal
      tags: [Search]
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 2
      responses:
        "200":
          description: Search results grouped into a flat list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: _k12_lms_session

  responses:
    Unauthorized:
      description: Not authenticated
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Not authenticated
    Forbidden:
      description: Not authorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Not authorized
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Not found
    ValidationErrors:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ValidationErrorsResponse"

  schemas:
    MeResponse:
      type: object
      required: [user, tenant]
      properties:
        user:
          $ref: "#/components/schemas/CurrentUser"
        tenant:
          $ref: "#/components/schemas/Tenant"

    CurrentUser:
      type: object
      required: [id, email, first_name, last_name, roles]
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        roles:
          type: array
          items:
            type: string
        google_connected:
          type: boolean
        onboarding_complete:
          type: boolean
        preferences:
          type: object
          additionalProperties: true

    Tenant:
      type: object
      required: [id, name, slug]
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string

    SessionDestroyResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: Signed out successfully

    Course:
      type: object
      required: [id, name, academic_year_id, created_at, updated_at]
      properties:
        id:
          type: integer
        name:
          type: string
        code:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        academic_year_id:
          type: integer
        sections:
          type: array
          items:
            $ref: "#/components/schemas/Section"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CourseCreateInput:
      type: object
      required: [academic_year_id, name]
      properties:
        academic_year_id:
          type: integer
        name:
          type: string
        code:
          type: string
        description:
          type: string

    CourseUpdateInput:
      type: object
      properties:
        academic_year_id:
          type: integer
        name:
          type: string
        code:
          type: string
        description:
          type: string

    Section:
      type: object
      required: [id, name, course_id, term_id, created_at, updated_at]
      properties:
        id:
          type: integer
        name:
          type: string
        course_id:
          type: integer
        term_id:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Assignment:
      type: object
      required: [id, course_id, created_by_id, title, assignment_type, status, created_at, updated_at]
      properties:
        id:
          type: integer
        course_id:
          type: integer
        created_by_id:
          type: integer
        rubric_id:
          type: integer
          nullable: true
        title:
          type: string
        description:
          type: string
          nullable: true
        instructions:
          type: string
          nullable: true
        assignment_type:
          type: string
        points_possible:
          type: number
          nullable: true
        due_at:
          type: string
          format: date-time
          nullable: true
        unlock_at:
          type: string
          format: date-time
          nullable: true
        lock_at:
          type: string
          format: date-time
          nullable: true
        submission_types:
          type: array
          items:
            type: string
        allow_late_submission:
          type: boolean
        status:
          type: string
        standard_ids:
          type: array
          items:
            type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AssignmentCreateInput:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        instructions:
          type: string
        assignment_type:
          type: string
        points_possible:
          type: number
        due_at:
          type: string
          format: date-time
        unlock_at:
          type: string
          format: date-time
        lock_at:
          type: string
          format: date-time
        allow_late_submission:
          type: boolean
        rubric_id:
          type: integer
        submission_types:
          type: array
          items:
            type: string

    Submission:
      type: object
      required: [id, assignment_id, user_id, submission_type, status, created_at, updated_at]
      properties:
        id:
          type: integer
        assignment_id:
          type: integer
        user_id:
          type: integer
        submission_type:
          type: string
        body:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
        status:
          type: string
        submitted_at:
          type: string
          format: date-time
          nullable: true
        attempt_number:
          type: integer
          nullable: true
        grade:
          type: number
          nullable: true
        graded_at:
          type: string
          format: date-time
          nullable: true
        graded_by_id:
          type: integer
          nullable: true
        feedback:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SubmissionCreateInput:
      type: object
      properties:
        submission_type:
          type: string
        body:
          type: string
        url:
          type: string
        attachment:
          type: string

    UnitPlan:
      type: object
      required: [id, title, status, course_id, created_by_id, created_at, updated_at]
      properties:
        id:
          type: integer
        title:
          type: string
        status:
          type: string
        course_id:
          type: integer
        created_by_id:
          type: integer
        current_version_id:
          type: integer
          nullable: true
        start_date:
          type: string
          format: date
          nullable: true
        end_date:
          type: string
          format: date
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Notification:
      type: object
      required: [id, user_id, notification_type, title, message, created_at, updated_at]
      properties:
        id:
          type: integer
        user_id:
          type: integer
        actor_id:
          type: integer
          nullable: true
        notification_type:
          type: string
        title:
          type: string
        message:
          type: string
        url:
          type: string
          nullable: true
        read_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UnreadCountResponse:
      type: object
      required: [count]
      properties:
        count:
          type: integer

    MarkAllReadResponse:
      type: object
      required: [updated]
      properties:
        updated:
          type: integer

    MessageThread:
      type: object
      required: [id, subject, thread_type, participants, unread_count, created_at, updated_at]
      properties:
        id:
          type: integer
        course_id:
          type: integer
          nullable: true
        course_name:
          type: string
          nullable: true
        subject:
          type: string
        thread_type:
          type: string
        participants:
          type: array
          items:
            $ref: "#/components/schemas/ThreadParticipant"
        last_message:
          $ref: "#/components/schemas/ThreadMessage"
        messages:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/ThreadMessage"
        unread_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ThreadParticipant:
      type: object
      required: [id, first_name, last_name, roles]
      properties:
        id:
          type: integer
        first_name:
          type: string
        last_name:
          type: string
        roles:
          type: array
          items:
            type: string

    ThreadMessage:
      type: object
      required: [id, message_thread_id, sender_id, body, sender, created_at, updated_at]
      properties:
        id:
          type: integer
        message_thread_id:
          type: integer
        sender_id:
          type: integer
        body:
          type: string
        sender:
          $ref: "#/components/schemas/ThreadParticipant"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Quiz:
      type: object
      required: [id, tenant_id, course_id, created_by_id, title, quiz_type, status, created_at, updated_at]
      properties:
        id:
          type: integer
        tenant_id:
          type: integer
        course_id:
          type: integer
        created_by_id:
          type: integer
        title:
          type: string
        description:
          type: string
          nullable: true
        instructions:
          type: string
          nullable: true
        quiz_type:
          type: string
        time_limit_minutes:
          type: integer
          nullable: true
        attempts_allowed:
          type: integer
          nullable: true
        shuffle_questions:
          type: boolean
        shuffle_choices:
          type: boolean
        show_results:
          type: string
          nullable: true
        points_possible:
          type: number
          nullable: true
        due_at:
          type: string
          format: date-time
          nullable: true
        unlock_at:
          type: string
          format: date-time
          nullable: true
        lock_at:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    GradebookRow:
      type: object
      required: [user_id, assignment_id, status]
      properties:
        user_id:
          type: integer
        assignment_id:
          type: integer
        grade:
          type: number
          nullable: true
        status:
          type: string

    SearchResponse:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/SearchResult"

    SearchResult:
      type: object
      required: [type, id, title, url]
      properties:
        type:
          type: string
        id:
          type: integer
        title:
          type: string
        url:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string

    ValidationErrorsResponse:
      type: object
      properties:
        errors:
          oneOf:
            - type: array
              items:
                type: string
            - type: object
              additionalProperties:
                type: array
                items:
                  type: string
